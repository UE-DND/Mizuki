---
import { Icon } from "astro-icon/components";

import type { DirectusPostEntry } from "@/utils/content-utils";
import { getPostUrl } from "@/utils/url-utils";

interface Props {
	class?: string;
	entry: DirectusPostEntry;
	style?: string;
}

const { entry, style } = Astro.props;
const className = Astro.props.class;

const {
	title,
	published,
	description,
	image,
	pinned,
	author,
	author_id,
	article_id,
	comment_count,
	like_count,
} = entry.data as DirectusPostEntry["data"] & {
	pinned?: boolean;
};

const url = getPostUrl(entry);
const hasCover =
	typeof image === "string" && image.trim().length > 0;
const coverWidth = "28%";
const bodyText = String(entry.body || "")
	.replace(/<[^>]+>/g, " ")
	.replace(/\s+/g, " ")
	.trim();
const excerpt = description || bodyText.slice(0, 140) || "";
const authorHandle = String(
	author?.username || author?.id || "user",
).trim();
const publishedDate =
	published instanceof Date && !Number.isNaN(published.getTime())
		? `${published.getFullYear()}/${String(published.getMonth() + 1).padStart(2, "0")}/${String(published.getDate()).padStart(2, "0")}`
		: "1970/01/01";
---

<div
	class:list={[
		"card-base flex flex-col-reverse md:flex-col w-full rounded-[var(--radius-large)] overflow-hidden relative",
		className,
	]}
	style={style}
	data-post-card
	data-article-id={article_id}
	data-author-id={author_id}
	data-author-handle={authorHandle}
	data-enter-skeleton-target="post-card"
>
	<div
		data-enter-skeleton-content
		class:list={[
			"pl-6 md:pl-9 pr-6 md:pr-2 pt-6 md:pt-7 pb-6 relative",
			{
				"w-full md:w-[calc(100%_-_3.25rem_-_0.75rem)]": !hasCover,
				"w-full md:w-[calc(100%_-_var(--coverWidth)_-_0.75rem)]": hasCover,
			},
		]}
	>
		<a
			href={url}
			class="transition group w-full block font-bold mb-3 text-2xl md:text-3xl text-90
        hover:text-[var(--primary)] dark:hover:text-[var(--primary)]
        active:text-[var(--title-active)] dark:active:text-[var(--title-active)]
        before:w-1 before:h-5 before:rounded-md before:bg-[var(--primary)]
        before:absolute
        before:top-[2.1875rem] before:left-[1.125rem] before:hidden md:before:block"
		>
			{
				pinned && (
					<Icon
						name="mdi:pin"
						class="inline text-[var(--primary)] text-2xl mr-2 -translate-y-0.5"
					/>
				)
			}
			{title}
			<Icon
				class="inline text-[2rem] text-[var(--primary)] md:hidden translate-y-0.5 absolute"
				name="material-symbols:chevron-right-rounded"
			/>
			<Icon
				class="text-[var(--primary)] text-[2rem] transition hidden md:inline absolute translate-y-0.5 opacity-0 group-hover:opacity-100 -translate-x-1 group-hover:translate-x-0"
				name="material-symbols:chevron-right-rounded"
			/>
		</a>

		<div class="mb-4 h-5" aria-hidden="true"></div>

		<div class="transition text-75 -mt-3 mb-3.5 pr-4 line-clamp-2 md:line-clamp-1">
			{excerpt}
		</div>

		<div class="flex items-center justify-between gap-3 mt-2">
			<div class="flex min-w-0 items-center gap-1.5 text-50 text-xs md:text-sm font-medium leading-none">
					<a href={`/${authorHandle}`} class="max-w-[10rem] truncate hover:text-[var(--primary)] transition-colors">@{authorHandle}</a>
				<span class="text-[var(--meta-divider)]" aria-hidden="true">·</span>
				<span>{publishedDate}</span>
			</div>
			<div class="flex items-center gap-3 md:gap-4 ml-3 mr-2 shrink-0 post-card-actions leading-none">
				<button
					type="button"
					class="inline-flex h-6 items-center gap-1.5 text-50 text-sm md:text-base font-medium hover:text-[var(--primary)] transition-colors post-card-action-btn"
					data-action="toggle-like"
					aria-label="切换点赞"
				>
					<Icon
						name="material-symbols:thumb-up-rounded"
						class="text-lg md:text-xl"
					/>
					<span data-like-count>{like_count}</span>
				</button>
				<a href={`${url}#directus-comment-root`} class="inline-flex h-6 items-center gap-1.5 text-50 text-sm md:text-base font-medium hover:text-[var(--primary)] transition-colors">
					<Icon
						name="material-symbols:comment-rounded"
						class="text-lg md:text-xl"
					/>
					<span>{comment_count}</span>
				</a>
				<details class="relative post-card-menu">
					<summary
						class="list-none cursor-pointer inline-flex items-center justify-center w-8 h-8 rounded-lg text-50 hover:text-[var(--primary)] hover:bg-[var(--btn-plain-bg-hover)] active:bg-[var(--btn-plain-bg-active)] transition-colors"
						aria-label="更多操作"
					>
						<Icon
							name="material-symbols:more-horiz"
							class="text-xl"
						/>
					</summary>
					<div class="absolute right-0 bottom-full mb-2 z-30 min-w-[10rem] rounded-xl border border-black/5 dark:border-white/10 bg-[var(--float-panel-bg)] p-1.5 shadow-xl dark:shadow-none">
						<button
							type="button"
							class="hidden w-full text-left px-3 py-2 text-xs md:text-sm rounded-lg text-black/75 dark:text-white/75 hover:text-[var(--primary)] hover:bg-[var(--btn-plain-bg-hover)] post-card-action-btn transition-colors"
							data-action="delete-own-article"
						>
							删除文章
						</button>
						<button
							type="button"
							class="hidden w-full text-left px-3 py-2 text-xs md:text-sm rounded-lg text-black/75 dark:text-white/75 hover:text-[var(--primary)] hover:bg-[var(--btn-plain-bg-hover)] post-card-action-btn transition-colors"
							data-action="delete-admin-article"
						>
							删除此文章(管理员)
						</button>
						<button
							type="button"
							class="w-full text-left px-3 py-2 text-xs md:text-sm rounded-lg text-black/75 dark:text-white/75 hover:text-[var(--primary)] hover:bg-[var(--btn-plain-bg-hover)] post-card-action-btn transition-colors"
							data-action="block-user"
						>
							屏蔽用户
						</button>
						<button
							type="button"
							class="w-full text-left px-3 py-2 text-xs md:text-sm rounded-lg text-amber-600 dark:text-amber-400 hover:bg-[var(--btn-plain-bg-hover)] post-card-action-btn transition-colors"
							data-action="report-content"
						>
							举报内容
						</button>
					</div>
				</details>
			</div>
		</div>
	</div>

	{
		hasCover && (
			<a
				data-enter-skeleton-content
				href={url}
				aria-label={title}
				class:list={[
					"group",
					"max-h-[20vh] md:max-h-none mx-4 mt-4 -mb-2 md:mb-0 md:mx-0 md:mt-0",
					"md:w-[var(--coverWidth)] relative md:absolute md:top-3 md:bottom-3 md:right-3 rounded-xl overflow-hidden active:scale-95",
				]}
			>
				<div class="absolute pointer-events-none z-10 w-full h-full group-hover:bg-black/30 group-active:bg-black/50 transition" />
				<div class="absolute pointer-events-none z-20 w-full h-full flex items-center justify-center">
					<Icon
						name="material-symbols:chevron-right-rounded"
						class="transition opacity-0 group-hover:opacity-100 scale-50 group-hover:scale-100 text-white text-5xl"
					/>
				</div>
				<img
					src={image || ""}
					alt={`Cover image of ${title}`}
					class="w-full h-full object-cover"
					loading="lazy"
				/>
			</a>
		)
	}

	{
		!hasCover && (
			<a
				data-enter-skeleton-content
				href={url}
				aria-label={title}
				class="hidden md:flex btn-regular w-[3.25rem]
         absolute right-3 top-3 bottom-3 rounded-xl bg-[var(--enter-btn-bg)]
         hover:bg-[var(--enter-btn-bg-hover)] active:bg-[var(--enter-btn-bg-active)] active:scale-95"
			>
				<Icon
					name="material-symbols:chevron-right-rounded"
					class="transition text-[var(--primary)] text-4xl mx-auto"
				/>
			</a>
		)
	}
	<div
		data-enter-skeleton-placeholder
		aria-hidden="true"
		class="absolute inset-0 z-20 pointer-events-none"
	>
		<div
			class:list={[
				"pl-6 md:pl-9 pr-6 md:pr-2 pt-6 md:pt-7 pb-6 h-full flex flex-col",
				{
					"w-full md:w-[calc(100%_-_3.25rem_-_0.75rem)]": !hasCover,
					"w-full md:w-[calc(100%_-_var(--coverWidth)_-_0.75rem)]": hasCover,
				},
			]}
		>
			<div class="space-y-3">
				<div class="md3-skeleton-text" style="--skeleton-width: 78%; --skeleton-height: 1.6rem;"></div>
				<div class="md3-skeleton-text hidden md:block" style="--skeleton-width: 48%; --skeleton-height: 1.6rem;"></div>
				<div class="md3-skeleton-text md:hidden" style="--skeleton-width: 56%; --skeleton-height: 1.35rem;"></div>
				<div class="pt-1.5 space-y-2">
					<div class="md3-skeleton-text" style="--skeleton-width: 94%;"></div>
					<div class="md3-skeleton-text" style="--skeleton-width: 72%;"></div>
				</div>
			</div>
			<div class="mt-auto flex items-center justify-between gap-3 pt-3">
				<div class="flex min-w-0 items-center gap-2">
					<div class="md3-skeleton-text w-20 md:w-24" style="--skeleton-height: 0.72rem;"></div>
					<div class="md3-skeleton-circle h-1.5 w-1.5"></div>
					<div class="md3-skeleton-text w-14 md:w-16" style="--skeleton-height: 0.72rem;"></div>
				</div>
				<div class="ml-3 mr-2 flex shrink-0 items-center gap-2.5 md:gap-4">
					<div class="md3-skeleton-block h-6 w-10 rounded-lg"></div>
					<div class="md3-skeleton-block h-6 w-10 rounded-lg"></div>
					<div class="md3-skeleton-circle h-8 w-8"></div>
				</div>
			</div>
		</div>
		{
			hasCover ? (
				<div
					class="max-h-[20vh] md:max-h-none mx-4 mt-4 -mb-2 md:mb-0 md:mx-0 md:mt-0 md:w-[var(--coverWidth)] relative md:absolute md:top-3 md:bottom-3 md:right-3 rounded-xl overflow-hidden"
				>
					<div class="md3-skeleton-block h-full w-full rounded-xl"></div>
				</div>
			) : (
				<div class="hidden md:flex absolute right-3 top-3 bottom-3 w-[3.25rem] rounded-xl overflow-hidden">
					<div class="md3-skeleton-block h-full w-full rounded-xl"></div>
				</div>
			)
		}
	</div>
</div>
<div
	class="transition border-t-[1px] border-dashed mx-6 border-black/10 dark:border-white/[0.15] last:border-t-0 md:hidden"
></div>

<style define:vars={{ coverWidth }}></style>
<style>
	.post-card-menu summary::-webkit-details-marker {
		display: none;
	}
</style>
