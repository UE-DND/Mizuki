---
import type { MarkdownHeading } from "astro";
import Announcement from "@/components/widget/Announcement.astro";
import Calendar from "@/components/widget/Calendar.astro";
import Categories from "@/components/widget/Categories.astro";
import MusicPlayer from "@/components/widget/MusicPlayer.svelte";
import Profile from "@/components/widget/Profile.astro";
import SiteStats from "@/components/widget/SiteStats.astro";
import Tags from "@/components/widget/Tags.astro";
import TOC from "@/components/widget/TOC.astro";
import type { JsonValue } from "@/types/json";
import type { WidgetComponentConfig } from "@/types/config";
import { widgetManager } from "@/utils/widget-manager";
import { pathsEqual, url } from "@/utils/url-utils";

interface Props {
	class?: string;
	headings?: MarkdownHeading[];
}

const { class: className, headings } = Astro.props;
const isHomePage = pathsEqual(Astro.url.pathname, url("/"));

const filterCalendar = (components: WidgetComponentConfig[]) => {
	if (isHomePage) {
		return components;
	}
	return components.filter((component) => component.type !== "calendar");
};

// 获取右侧边栏的组件列表
const topComponents = filterCalendar(
	widgetManager.getComponentsByPosition("top", "right"),
);
const stickyComponents = filterCalendar(
	widgetManager.getComponentsByPosition("sticky", "right"),
);

const stickyContainerClass = "transition-all duration-700 flex flex-col w-full gap-4 sticky top-4";

// 组件映射表
const componentMap = {
	profile: Profile,
	announcement: Announcement,
	categories: Categories,
	tags: Tags,
	"music-player": MusicPlayer,
	"site-stats": SiteStats,
	calendar: Calendar,
};

type TocRenderData = {
	type: "toc";
	class: string;
	style: string;
	headings: MarkdownHeading[];
	customProps: WidgetComponentConfig["customProps"];
};

type ComponentRenderData = {
	type: "component";
	Component: (typeof componentMap)[keyof typeof componentMap];
	props: Record<string, JsonValue>;
};

type RenderData = TocRenderData | ComponentRenderData;

// 渲染组件的辅助函数
function renderComponent(
	component: WidgetComponentConfig,
	index: number,
): RenderData | null {
	const componentClass = widgetManager.getComponentClass(component, index);
	const componentStyle = widgetManager.getComponentStyle(component, index);

	if (component.type === "toc") {
		return {
			type: "toc",
			class: componentClass,
			style: componentStyle,
			headings: headings ?? [],
			customProps: component.customProps,
		};
	}

	const ComponentToRender =
		componentMap[component.type as keyof typeof componentMap];
	if (!ComponentToRender) {return null;}

	return {
		type: "component",
		Component: ComponentToRender,
		props: {
			class: componentClass,
			style: componentStyle,
			...(component.customProps ?? {}),
		},
	};
}
---

<div id="right-sidebar" class:list={[className, "w-full"]}>
  <!-- 顶部固定组件区域 -->
  {
    topComponents.length > 0 && (
      <div class="flex flex-col w-full gap-4 mb-4">
        {topComponents.map((component, index) => {
          const renderData = renderComponent(component, index);
          if (!renderData) {return null;}

          if (renderData.type === "toc") {
            return (
              <TOC
                class={renderData.class}
                style={renderData.style}
                headings={renderData.headings}
                {...(renderData.customProps ?? {})}
              />
            );
          }

          const { Component, props } = renderData;
          return <Component {...props} />;
        })}
      </div>
    )
  }

  <!-- 粘性组件区域 -->
  {
    stickyComponents.length > 0 && (
      <div
        id="right-sidebar-sticky"
        class={stickyContainerClass}
      >
        {stickyComponents.map((component, index) => {
          const renderData = renderComponent(component, index);
          if (!renderData) {return null;}

          if (renderData.type === "toc") {
            return (
              <TOC
                class={renderData.class}
                style={renderData.style}
                headings={renderData.headings}
                {...(renderData.customProps ?? {})}
              />
            );
          }

          const { Component, props } = renderData;
          return <Component {...props} />;
        })}
      </div>
    )
  }
</div>

<!-- 响应式样式和JavaScript -->
<style>
  /* 响应式断点样式 */
  @media (max-width: 768px) {
    #right-sidebar {
      display: var(--sidebar-mobile-display, block);
    }
  }

  @media (min-width: 769px) and (max-width: 1024px) {
    #right-sidebar {
      display: var(--sidebar-tablet-display, block);
    }
  }

  @media (min-width: 1025px) {
    #right-sidebar {
      display: var(--sidebar-desktop-display, block);
    }
  }
</style>

<script>
  import { widgetManager } from "../../utils/widget-manager";
  
  // 响应式布局管理
  class RightSidebarManager {
    constructor() {
      this.init();
    }
    
    init() {
      this.updateResponsiveDisplay();
      window.addEventListener('resize', () => this.updateResponsiveDisplay());
      
      // 监听SWUP内容替换事件
      if (typeof window !== "undefined" && window.swup?.hooks) {
        window.swup.hooks.on("content:replace", () => {
          // 延迟执行以确保DOM已更新
          setTimeout(() => {
            this.updateResponsiveDisplay();
          }, 100);
        });
      }
    }
    
    updateResponsiveDisplay() {
      const breakpoints = widgetManager.getBreakpoints();
      const width = window.innerWidth;
      
      let deviceType: 'mobile' | 'tablet' | 'desktop';
      if (width < breakpoints.mobile) {
        deviceType = 'mobile';
      } else if (width < breakpoints.tablet) {
        deviceType = 'tablet';
      } else {
        deviceType = 'desktop';
      }
      
      const shouldShow = widgetManager.shouldShowSidebar(deviceType);
      const sidebar = document.getElementById('right-sidebar');
      
      if (sidebar) {
        sidebar.style.setProperty(
          `--sidebar-${deviceType}-display`, 
          shouldShow ? 'block' : 'none'
        );
      }
    }
  }
  
  // 初始化右侧边栏管理器
  new RightSidebarManager();
</script>
