---
import { Icon } from "astro-icon/components";
import { navBarConfig, siteConfig } from "../config";
import { LinkPresets } from "../constants/link-presets";
import type { LinkPreset} from "../types/config";
import { type NavBarLink } from "../types/config";
import { isAdminOnlyLink } from "../utils/nav-link-utils";
import { url } from "../utils/url-utils";
import LightDarkSwitch from "./LightDarkSwitch.svelte";
import MobileTOC from "./MobileTOC.svelte";
import Search from "./Search.svelte";
import AuthStatus from "./auth/AuthStatus.astro";
import DropdownMenu from "./widget/DropdownMenu.astro";
import NavMenuPanel from "./widget/NavMenuPanel.astro";

const className = Astro.props.class;

// 获取导航栏透明模式配置
const navbarTransparentMode =
	siteConfig.banner?.navbar?.transparentMode || "semi";

// 检查是否为首页
const isHomePage = Astro.url.pathname === "/" || Astro.url.pathname === "";

function resolveLink(link: NavBarLink | LinkPreset): NavBarLink {
	if (typeof link === "number") {
		return LinkPresets[link];
	}
	return link;
}

function withoutAdminChildren(link: NavBarLink): NavBarLink | null {
	if (isAdminOnlyLink(link)) {
		return null;
	}
	const childrenSource = Array.isArray(link.children) ? link.children : [];
	if (childrenSource.length === 0) {
		return link;
	}
	const children = childrenSource
		.map((child) => resolveLink(child))
		.filter((child) => !isAdminOnlyLink(child));
	if (children.length === 0) {
		const rawUrl = String(link.url || "").trim();
		if (!rawUrl || rawUrl === "#") {
			return null;
		}
	}
	return { ...link, children };
}

const links: NavBarLink[] = navBarConfig.links
	.map((item) => resolveLink(item))
	.map((item) => withoutAdminChildren(item))
	.filter((item): item is NavBarLink => Boolean(item));
---
<div id="navbar" class="z-50 onload-animation group" data-transparent-mode={navbarTransparentMode} data-is-home={isHomePage}>
    <div class="absolute h-8 left-0 right-0 -top-8 bg-[var(--card-bg)] transition"></div> <!-- used for onload animation -->
    <div class:list={[className, "!overflow-visible max-w-[var(--page-width)] h-[4.5rem] mx-auto flex items-center justify-between px-4"]}>
        <a href={url('/')} class="btn-plain scale-animation rounded-lg h-[3.25rem] [.enable-banner_&]:h-[2.5rem] [.enable-banner_&]:group-[.scrolled]:h-[3.25rem] px-5 font-bold active:scale-95 shrink-0 transition-all duration-[600ms]">
            <div class="flex flex-row items-center text-md">
				{/* 使用navbarTitle配置或默认配置 */}
                {siteConfig.navbarTitle ? (
                    siteConfig.navbarTitle.mode === "logo" ? (
					<img src={url(siteConfig.navbarTitle.logo || "/assets/home/default-logo.png")} alt={siteConfig.navbarTitle.text} class="h-[3.25rem] [.enable-banner_&]:h-[2.5rem] [.enable-banner_&]:group-[.scrolled]:h-[3.25rem] max-w-full object-contain transition-all duration-[600ms]" loading="lazy" />
                    ) : (
                        <>
						<img src={url(siteConfig.navbarTitle.icon || "/assets/home/home.png")} alt={siteConfig.navbarTitle.text} class="h-[1.75rem] w-[1.75rem] mr-2 object-contain" loading="lazy" />
                            <span class="dark:text-white text-black">{siteConfig.navbarTitle.text}</span>
                        </>
                    )
                ) : (
                    <>
					<Icon name="material-symbols:home-pin-outline" class="text-[1.75rem] mr-2" />
                        <span class="dark:text-white text-black">{siteConfig.title}</span>
                    </>
                )}
            </div>
        </a>
        <div id="navbar-links-container" class="hidden md:flex items-center space-x-1 transition-opacity duration-300">
            {links.map((l) => {
                return <DropdownMenu link={l} />;
            })}
        </div>
        <div class="flex items-center gap-1">
            <div id="search-container">
                <Search client:only="svelte"></Search>
            </div>
            {siteConfig.toc.enable && <MobileTOC client:only="svelte"></MobileTOC>}
            <LightDarkSwitch client:only="svelte"></LightDarkSwitch>
            <button aria-label="Menu" name="Nav Menu" class="btn-plain scale-animation rounded-lg w-11 h-11 active:scale-90 md:!hidden" id="nav-menu-switch">
                <Icon name="material-symbols:unfold-more" class="text-[1.25rem]"></Icon>
            </button>
			<AuthStatus />
        </div>
        <NavMenuPanel links={links}></NavMenuPanel>
    </div>
</div>

<script>
    import {
        emitAuthState,
        getAuthState,
        subscribeAuthState,
        type AuthState,
    } from "@/scripts/auth-state";
    import { showLoginOverlay } from "@/scripts/login-overlay";

	const searchContainer = document.getElementById("search-container");
	const navbarLinksContainer = document.getElementById("navbar-links-container");

    const updateUserRouteLinks = (username: string, isLoggedIn: boolean): void => {
        const cleanUsername = String(username || "").trim();
        const anchors = Array.from(
            document.querySelectorAll<HTMLAnchorElement>("a[href]"),
        );
        anchors.forEach((anchor) => {
            const rawHref = anchor.getAttribute("href") || "";
            if (!rawHref.startsWith("/")) return;
            if (rawHref.includes("/__user__/")) {
                if (cleanUsername) {
                    anchor.setAttribute(
                        "href",
                        rawHref.replace("/__user__/", `/${cleanUsername}/`),
                    );
                    anchor.removeAttribute("data-needs-login");
                } else if (!isLoggedIn) {
                    anchor.setAttribute("href", "#");
                    anchor.setAttribute("data-needs-login", "");
                } else {
                    anchor.setAttribute("href", "/me/");
                    anchor.removeAttribute("data-needs-login");
                }
                return;
            }
            let pathname = rawHref;
            let hash = "";
            try {
                const parsed = new URL(rawHref, window.location.origin);
                pathname = parsed.pathname;
                hash = parsed.hash.replace(/^#/, "").trim().toLowerCase();
            } catch {
                pathname = rawHref;
            }
            if (pathname === "/me" || pathname === "/me/") {
                if (hash === "anime" || hash === "diary" || hash === "albums") {
                    if (cleanUsername) {
                        anchor.setAttribute("href", `/${cleanUsername}/${hash}/`);
                        anchor.removeAttribute("data-needs-login");
                    } else if (!isLoggedIn) {
                        anchor.setAttribute("href", "#");
                        anchor.setAttribute("data-needs-login", "");
                    }
                }
                return;
            }
            const legacyTarget = ["/anime", "/anime/", "/diary", "/diary/", "/albums", "/albums/"];
            if (!legacyTarget.includes(pathname)) return;
            const target = pathname.replace(/^\//, "").replace(/\/$/, "");
            if (cleanUsername) {
                anchor.setAttribute("href", `/${cleanUsername}/${target}/`);
                anchor.removeAttribute("data-needs-login");
            } else if (!isLoggedIn) {
                anchor.setAttribute("href", "#");
                anchor.setAttribute("data-needs-login", "");
            } else {
                anchor.setAttribute("href", "/me/");
                anchor.removeAttribute("data-needs-login");
            }
        });
    };

    const fetchAuthProfile = async () => {
        try {
            const response = await fetch("/api/auth/me/", {
                method: "GET",
                credentials: "include",
                headers: { Accept: "application/json" },
                cache: "no-store",
            });
            const data = await response.json().catch(() => null);
            if (!response.ok || !data?.ok) {
                return { ok: false, username: "", isAdmin: false, userId: "" };
            }
            return {
                ok: true,
                username: String(data?.user?.username || "").trim(),
                isAdmin: Boolean(data?.is_admin || data?.isAdmin),
                userId: String(data?.user?.id || "").trim(),
            };
        } catch (error) {
            console.warn("[navbar] failed to load username:", error);
            return { ok: false, username: "", isAdmin: false, userId: "" };
        }
    };

    const applyAuthRouting = async (state: AuthState | null | undefined): Promise<void> => {
        let username = String(state?.username || "").trim();
        let isLoggedIn = Boolean(state?.isLoggedIn);
        if (!username) {
            const profile = await fetchAuthProfile();
            if (profile.ok) {
                username = profile.username;
                isLoggedIn = true;
                emitAuthState({
                    isLoggedIn: true,
                    isAdmin: profile.isAdmin,
                    userId: profile.userId,
                    username,
                });
            }
        }
        updateUserRouteLinks(username, isLoggedIn);
    };

    const initialAuth = getAuthState();
    applyAuthRouting(initialAuth);
    subscribeAuthState((state) => {
        applyAuthRouting(state);
    });

    document.addEventListener("astro:after-swap", () => {
        applyAuthRouting(getAuthState());
    });

    document.addEventListener("click", (e) => {
        const anchor = (e.target as Element).closest?.("a[data-needs-login]");
        if (anchor) {
            e.preventDefault();
            showLoginOverlay();
        }
    });

	if (searchContainer && navbarLinksContainer) {
		// 鼠标移入/触摸开始时隐藏导航链接
		const hideLinks = () => {
			if (window.matchMedia("(min-width: 1280px)").matches && window.matchMedia("(hover: hover)").matches) {
				navbarLinksContainer.style.opacity = "0";
			}
		};

		// 鼠标移出/触摸结束时显示导航链接
		const showLinks = () => {
			const navbar = document.getElementById("navbar");
			if (navbar && !navbar.classList.contains("is-searching")) {
				navbarLinksContainer.style.opacity = "1";
			}
		};

		searchContainer.addEventListener("mouseenter", hideLinks);
		searchContainer.addEventListener("mouseleave", showLinks);

		// 移动端/触摸屏支持
		searchContainer.addEventListener("touchstart", hideLinks, { passive: true });
		searchContainer.addEventListener("touchend", showLinks);

		// 监听 navbar 的 class 变化，当搜索框折叠时确保链接显示
		const navbar = document.getElementById("navbar");
		if (navbar) {
			const observer = new MutationObserver((mutations) => {
				mutations.forEach((mutation) => {
					if (mutation.type === "attributes" && mutation.attributeName === "class") {
						if (!navbar.classList.contains("is-searching")) {
							// 搜索框已折叠，如果此时鼠标不在搜索容器内，强制显示链接
							if (!searchContainer.matches(':hover')) {
								showLinks();
							}
						}
					}
				});
			});
			observer.observe(navbar, { attributes: true });
		}
	}

async function loadButtonScript() {
    try {
        // 导入面板管理器
        const { panelManager } = await import('../utils/panel-manager.js');

        const menuBtn = document.getElementById("nav-menu-switch");
        if (menuBtn) {
            menuBtn.onclick = async function () {
                await panelManager.togglePanel('nav-menu-panel');
            };
        }
    } catch (error) {
        console.error('Failed to load panel manager:', error);
        // 备用逻辑
        const menuBtn = document.getElementById("nav-menu-switch");
        if (menuBtn) {
            menuBtn.onclick = function () {
                const menuPanel = document.getElementById("nav-menu-panel");
                if (menuPanel) {
                    menuPanel.classList.toggle("float-panel-closed");
                }
            };
        }
    }
}

loadButtonScript();

// 为semifull模式添加滚动检测逻辑
function initSemifullScrollDetection() {
    const navbar = document.getElementById('navbar');
    if (!navbar) return;
    
    // 移除之前的滚动事件监听器（如果存在）
    // @ts-ignore
    if (window.semifullScrollHandler) {
        // @ts-ignore
        window.removeEventListener('scroll', window.semifullScrollHandler);
    }
    
    let ticking = false;
    
    function updateNavbarState() {
        const scrollTop = window.scrollY || document.documentElement.scrollTop;
        const threshold = 50; // 滚动阈值，可以根据需要调整
        
        if (navbar && scrollTop > threshold) {
            navbar.classList.add('scrolled');
        } else if (navbar) {
            navbar.classList.remove('scrolled');
        }
        
        ticking = false;
    }
    
    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(updateNavbarState);
            ticking = true;
        }
    }
    
    // 保存新的事件处理器引用
    // @ts-ignore
    window.semifullScrollHandler = requestTick;
    
    // 监听滚动事件
    window.addEventListener('scroll', requestTick, { passive: true });
    
    // 初始化状态
    updateNavbarState();
}

// 将函数暴露到全局对象，供页面切换时调用
// @ts-ignore
window.initSemifullScrollDetection = initSemifullScrollDetection;

// 页面加载完成后初始化滚动检测
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSemifullScrollDetection);
} else {
    initSemifullScrollDetection();
}
</script>

{import.meta.env.PROD && <script is:inline define:vars={{scriptUrl: url('/pagefind/pagefind.js')}}>
async function loadPagefind() {
    try {
        const response = await fetch(scriptUrl, { method: 'HEAD' });
        if (!response.ok) {
            throw new Error(`Pagefind script not found: ${response.status}`);
        }

        const pagefind = await import(scriptUrl);

        await pagefind.options({
            excerptLength: 20
        });

        window.pagefind = pagefind;

        document.dispatchEvent(new CustomEvent('pagefindready'));
        console.log('Pagefind loaded and initialized successfully, event dispatched.');
    } catch (error) {
        console.error('Failed to load Pagefind:', error);
        window.pagefind = {
            search: () => Promise.resolve({ results: [] }),
            options: () => Promise.resolve(),
        };
        document.dispatchEvent(new CustomEvent('pagefindloaderror'));
        console.log('Pagefind load error, event dispatched.');
    }
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadPagefind);
} else {
    loadPagefind();
}
</script>}
