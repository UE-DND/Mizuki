---
interface Props {
	module?: "articles" | "diaries";
	contentId?: string;
	allowComments?: boolean;
}

const moduleName = Astro.props.module;
const contentId = Astro.props.contentId;
const enabled =
	typeof Astro.props.allowComments === "boolean" ? Astro.props.allowComments : true;

const hasDirectusTarget = Boolean(moduleName && contentId);
---

{enabled && (
	<div
		class="card-base p-6 mb-4"
		id="directus-comment-root"
		data-module={moduleName || ""}
		data-content-id={contentId || ""}
		data-directus-enabled={hasDirectusTarget ? "1" : "0"}
	>
		<div class="flex items-center justify-between mb-4">
			<h3 class="text-xl font-semibold text-90">评论</h3>
		</div>

		{!hasDirectusTarget && (
			<p class="text-sm text-70 rounded-xl border border-[var(--line-divider)] px-4 py-3">
				旧评论系统已移除。该页面未绑定 Directus 评论对象。
			</p>
		)}

		{hasDirectusTarget && (
			<>
				<form id="comment-create-form" class="space-y-3 mb-6">
					<input type="hidden" id="comment-parent-id" value="" />
					<textarea
						id="comment-body"
						rows="4"
						class="w-full rounded-xl border border-[var(--line-divider)] bg-transparent px-4 py-3 text-90 focus:outline-none focus:border-[var(--primary)]"
						placeholder="写下你的评论..."
					></textarea>
					<div class="flex items-center justify-between gap-2">
						<div class="text-xs text-60" id="comment-reply-hint"></div>
						<div class="flex items-center gap-2">
							<button
								type="button"
								id="comment-reply-cancel"
								class="hidden px-3 py-2 rounded-lg border border-[var(--line-divider)] text-xs text-75"
							>
								取消回复
							</button>
							<button
								type="submit"
								id="comment-submit"
								class="px-4 py-2 rounded-lg bg-[var(--btn-regular-bg)] text-[var(--btn-content)] text-sm"
							>
								发布评论
							</button>
						</div>
					</div>
					<p id="comment-form-error" class="hidden text-sm text-red-500"></p>
				</form>

				<div id="comment-list" class="space-y-4"></div>
				<div id="comment-empty" class="hidden text-sm text-60 rounded-xl border border-[var(--line-divider)] px-4 py-3">
					暂无评论，来抢沙发吧。
				</div>
			</>
		)}
	</div>
)}

<script>
	import { getAuthState, subscribeAuthState } from "@/scripts/auth-state";
	import type { AuthState } from "@/scripts/auth-state";
	import { showAuthRequiredDialog } from "@/scripts/dialogs";

	type CommentAuthor = {
		name?: string | null;
		avatar_url?: string | null;
	};
	type CommentItem = {
		id: string;
		author_id?: string | null;
		author?: CommentAuthor | null;
		date_created?: string | null;
		body?: string | null;
		replies?: CommentItem[] | null;
	};

	const runtimeWindow = window as Window &
		typeof globalThis & {
			_directusCommentAuthSubscribed?: boolean;
			_directusCommentApplyAuth?: (state: AuthState) => void;
		};

	function initComments() {
		const root = document.getElementById("directus-comment-root");
		if (!root) return;

		const moduleName = String(root.dataset.module || "").trim();
		const contentId = String(root.dataset.contentId || "").trim();
		const directusEnabled = root.dataset.directusEnabled === "1";

		const commentListEl = document.getElementById("comment-list");
		const commentEmptyEl = document.getElementById("comment-empty");
		const formEl = document.getElementById(
			"comment-create-form",
		) as HTMLFormElement | null;
		const bodyEl = document.getElementById(
			"comment-body",
		) as HTMLTextAreaElement | null;
		const parentIdEl = document.getElementById(
			"comment-parent-id",
		) as HTMLInputElement | null;
		const submitEl = document.getElementById(
			"comment-submit",
		) as HTMLButtonElement | null;
		const formErrorEl = document.getElementById("comment-form-error");
		const replyHintEl = document.getElementById("comment-reply-hint");
		const replyCancelEl = document.getElementById("comment-reply-cancel");

		let currentUserId = "";
		let isAdmin = false;
		let comments: CommentItem[] = [];

		const escapeHtml = (raw: unknown): string =>
			String(raw || "")
				.replaceAll("&", "&amp;")
				.replaceAll("<", "&lt;")
				.replaceAll(">", "&gt;")
				.replaceAll('"', "&quot;")
				.replaceAll("'", "&#039;");

		const formatDate = (iso: string | null | undefined): string => {
			if (!iso) return "";
			const time = new Date(iso);
			if (Number.isNaN(time.getTime())) return "";
			return time.toLocaleString();
		};

		const commentApiBase = () => {
			if (moduleName === "diaries") {
				return `/api/v1/diaries/${encodeURIComponent(contentId)}/comments`;
			}
			return `/api/v1/articles/${encodeURIComponent(contentId)}/comments`;
		};

		const commentItemApi = (commentId: string): string => {
			if (moduleName === "diaries") {
				return `/api/v1/diaries/comments/${encodeURIComponent(commentId)}`;
			}
			return `/api/v1/articles/comments/${encodeURIComponent(commentId)}`;
		};

		const setFormError = (message: string): void => {
			if (!formErrorEl) return;
			if (!message) {
				formErrorEl.classList.add("hidden");
				formErrorEl.textContent = "";
				return;
			}
			formErrorEl.textContent = message;
			formErrorEl.classList.remove("hidden");
		};

		const setReplyState = (parentId: string, authorName: string): void => {
			if (!parentIdEl || !replyHintEl || !replyCancelEl) return;
			parentIdEl.value = parentId || "";
			if (parentId) {
				replyHintEl.textContent = `正在回复 ${authorName || "该用户"}`;
				replyCancelEl.classList.remove("hidden");
			} else {
				replyHintEl.textContent = "";
				replyCancelEl.classList.add("hidden");
			}
		};

		const canDeleteComment = (item: CommentItem): boolean => {
			return (
				Boolean(currentUserId) &&
				Boolean(item) &&
				(item.author_id === currentUserId || isAdmin)
			);
		};

		const renderCommentActions = (item: CommentItem, level: number): string => {
			const canReply = level === 0;
			const canDelete = canDeleteComment(item);
			if (!canReply && !canDelete) return "";

			const menuActions: string[] = [];
			if (canReply) {
				menuActions.push(
					`<button type="button" class="comment-action w-full text-left px-3 py-2 rounded-lg text-sm hover:bg-black/5 dark:hover:bg-white/10" data-action="reply" data-id="${escapeHtml(item.id)}" data-author="${escapeHtml(item.author?.name || "用户")}">回复</button>`,
				);
			}
			if (canDelete) {
				menuActions.push(
					`<button type="button" class="comment-action w-full text-left px-3 py-2 rounded-lg text-sm text-red-500 hover:bg-black/5 dark:hover:bg-white/10" data-action="delete" data-id="${escapeHtml(item.id)}">删除</button>`,
				);
			}

			return `
				<details class="relative comment-action-menu">
						<summary class="list-none cursor-pointer btn-plain scale-animation w-8 h-8 rounded-lg flex items-center justify-center text-base select-none text-75" aria-label="评论操作">...</summary>
						<div class="absolute right-0 top-9 z-10 min-w-[7rem] card-base rounded-xl border border-[var(--line-divider)] p-2 text-90">
						${menuActions.join("")}
					</div>
				</details>
			`;
		};

		const renderCommentNode = (item: CommentItem, level: number): string => {
			const avatar = item.author?.avatar_url
				? `<img src="${escapeHtml(item.author.avatar_url)}" alt="用户头像" class="w-8 h-8 rounded-full object-cover" loading="lazy" />`
				: `<div class="w-8 h-8 rounded-full bg-black/10 dark:bg-white/10"></div>`;
			const replies = Array.isArray(item.replies) ? item.replies : [];

			return `
				<div class="comment-node ${level > 0 ? "ml-8 mt-3" : ""}" data-comment-id="${escapeHtml(item.id)}">
					<div class="rounded-xl border border-[var(--line-divider)] p-4 space-y-3 text-90">
						<div class="flex items-start justify-between gap-3">
							<div class="flex items-center gap-3 min-w-0">
								${avatar}
								<div class="min-w-0">
									<div class="text-sm font-medium truncate text-90">${escapeHtml(item.author?.name || "匿名用户")}</div>
									<div class="text-xs text-60">${escapeHtml(formatDate(item.date_created))}</div>
								</div>
							</div>
							${renderCommentActions(item, level)}
						</div>
						<div class="text-sm leading-7 whitespace-pre-wrap break-words text-90">${escapeHtml(item.body || "")}</div>
					</div>
					<div class="space-y-2">${replies
						.map((reply: CommentItem) => renderCommentNode(reply, 1))
						.join("")}</div>
				</div>
			`;
		};

		const renderComments = () => {
			if (!commentListEl || !commentEmptyEl) return;
			if (!Array.isArray(comments) || comments.length === 0) {
				commentListEl.innerHTML = "";
				commentEmptyEl.classList.remove("hidden");
				return;
			}
			commentEmptyEl.classList.add("hidden");
			commentListEl.innerHTML = comments
				.map((item) => renderCommentNode(item, 0))
				.join("");
		};

		const applyAuthState = (state: AuthState): void => {
			currentUserId = state.isLoggedIn ? state.userId : "";
			isAdmin = state.isLoggedIn && state.isAdmin;
			renderComments();
		};

		// Expose latest applyAuthState for global auth subscription
		runtimeWindow._directusCommentApplyAuth = applyAuthState;

		const loadComments = async () => {
			if (!directusEnabled) return;
			try {
				const response = await fetch(commentApiBase(), {
					headers: { Accept: "application/json" },
					credentials: "include",
				});
				const data = await response.json().catch(() => null);
				if (!response.ok || !data?.ok) {
					comments = [];
					renderComments();
					return;
				}
				comments = Array.isArray(data.items)
					? (data.items as CommentItem[])
					: [];
				renderComments();
			} catch {
				comments = [];
				renderComments();
			}
		};

		const submitComment = async () => {
			if (!bodyEl || !submitEl || !parentIdEl) return;

			if (!currentUserId) {
				showAuthRequiredDialog("请先登录后再发表评论。");
				return;
			}

			const body = String(bodyEl.value || "").trim();
			if (!body) {
				setFormError("评论内容不能为空");
				return;
			}

			setFormError("");
			submitEl.disabled = true;
			submitEl.textContent = "提交中...";
			try {
				const response = await fetch(commentApiBase(), {
					method: "POST",
					credentials: "include",
					headers: {
						"Content-Type": "application/json",
						Accept: "application/json",
					},
					body: JSON.stringify({
						body,
						parent_id: parentIdEl.value || null,
					}),
				});
				const data = await response.json().catch(() => null);
				if (!response.ok || !data?.ok) {
					setFormError(data?.message || "评论提交失败");
					return;
				}
				bodyEl.value = "";
				setReplyState("", "");
				await loadComments();
			} catch {
				setFormError("评论提交失败，请稍后重试");
			} finally {
				submitEl.disabled = false;
				submitEl.textContent = "发布评论";
			}
		};

		const deleteComment = async (commentId: string): Promise<void> => {
			const confirmed = window.confirm("确认删除该评论？");
			if (!confirmed) return;
			const response = await fetch(commentItemApi(commentId), {
				method: "DELETE",
				credentials: "include",
				headers: { Accept: "application/json" },
			});
			const data = await response.json().catch(() => null);
			if (!response.ok || !data?.ok) {
				window.alert(data?.message || "删除失败");
				return;
			}
			await loadComments();
		};

		if (formEl && !formEl.dataset.bound) {
			formEl.dataset.bound = "1";
			formEl.addEventListener("submit", async (event) => {
				event.preventDefault();
				await submitComment();
			});
		}

		if (replyCancelEl && !replyCancelEl.dataset.bound) {
			replyCancelEl.dataset.bound = "1";
			replyCancelEl.addEventListener("click", () => {
				setReplyState("", "");
			});
		}

		if (commentListEl && !commentListEl.dataset.bound) {
			commentListEl.dataset.bound = "1";
			commentListEl.addEventListener("click", async (event) => {
				const target =
					event.target instanceof HTMLElement ? event.target : null;
				if (!target) return;
				const actionEl = target.closest(".comment-action");
				if (!(actionEl instanceof HTMLElement)) return;
				const action = actionEl.dataset.action || "";
				const id = actionEl.dataset.id || "";
				if (!id) return;

				if (action === "reply") {
					setReplyState(id, actionEl.dataset.author || "用户");
					bodyEl?.focus();
					return;
				}
				if (action === "delete") {
					await deleteComment(id);
				}
			});
		}

		if (!runtimeWindow._directusCommentAuthSubscribed) {
			runtimeWindow._directusCommentAuthSubscribed = true;
			subscribeAuthState((state) => {
				runtimeWindow._directusCommentApplyAuth?.(state);
			});
		}

		if (!directusEnabled) return;
		applyAuthState(getAuthState());
		loadComments();
	}

	initComments();
	document.addEventListener("astro:after-swap", initComments);
</script>
