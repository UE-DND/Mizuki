---
import { systemSiteConfig } from "../../config";
import I18nKey from "../../i18n/i18nKey";
import { i18n } from "../../i18n/translation";
import WidgetLayout from "./WidgetLayout.astro";
import { Icon } from "astro-icon/components";

interface Props {
  class?: string;
  style?: string;
  defaultExpanded?: boolean;
}

const { class: className, style, defaultExpanded = true } = Astro.props;

const monthNames = [
  i18n(I18nKey.calendarJanuary),
  i18n(I18nKey.calendarFebruary),
  i18n(I18nKey.calendarMarch),
  i18n(I18nKey.calendarApril),
  i18n(I18nKey.calendarMay),
  i18n(I18nKey.calendarJune),
  i18n(I18nKey.calendarJuly),
  i18n(I18nKey.calendarAugust),
  i18n(I18nKey.calendarSeptember),
  i18n(I18nKey.calendarOctober),
  i18n(I18nKey.calendarNovember),
  i18n(I18nKey.calendarDecember),
];

const weekDays = [
  i18n(I18nKey.calendarMonday),
  i18n(I18nKey.calendarTuesday),
  i18n(I18nKey.calendarWednesday),
  i18n(I18nKey.calendarThursday),
  i18n(I18nKey.calendarFriday),
  i18n(I18nKey.calendarSaturday),
  i18n(I18nKey.calendarSunday),
];

const isChinese = systemSiteConfig.lang.startsWith("zh");
const yearSuffix = isChinese ? "年" : " ";
const calendarTitle = isChinese ? "日期" : "Date";
---

<WidgetLayout id="calendar-widget" class={className} style={style}>
  <div
    class="calendar-shell font-bold transition text-lg text-neutral-900 dark:text-neutral-100 relative ml-4 mt-4 mb-0 flex items-center justify-between gap-2
			before:w-1 before:h-4 before:rounded-md before:bg-(--primary)
			before:absolute before:left-[-16px] before:top-[5.5px]"
  >
    <div class="min-w-0 flex items-center gap-2">
      <span class="shrink-0">{calendarTitle}</span>
    </div>
    <button
      id="calendar-toggle-btn"
      type="button"
      aria-controls="calendar-body"
      aria-expanded={defaultExpanded ? "true" : "false"}
      class="calendar-toggle-btn p-1.5 rounded-md hover:bg-(--btn-plain-bg-hover) text-neutral-600 dark:text-neutral-400 hover:text-(--primary) transition-colors shrink-0"
    >
      <Icon
        id="calendar-toggle-icon"
        name="material-symbols:expand-more-rounded"
        class:list={[
          "text-xl transition-transform duration-200",
          { "rotate-180": defaultExpanded },
        ]}
      />
    </button>
  </div>

  <div
    id="calendar-body"
    class:list={["calendar-body", { expanded: defaultExpanded }]}
  >
    <div
      id="calendar-loading"
      class="hidden py-2 text-sm text-neutral-600 dark:text-neutral-300"
    >
      {isChinese ? "正在加载日历..." : "Loading calendar..."}
    </div>
    <div id="calendar-load-error" class="hidden py-2">
      <div
        id="calendar-load-error-text"
        class="text-sm text-red-600 dark:text-red-300"
      >
      </div>
      <button
        id="calendar-retry-btn"
        type="button"
        class="mt-2 text-sm text-(--primary) hover:underline cursor-pointer"
      >
        {isChinese ? "重试" : "Retry"}
      </button>
    </div>

    <div id="calendar-content" class="hidden">
      <div class="flex justify-between items-center mb-2 mt-2">
        <div class="flex items-center gap-1 min-w-0">
          <div
            id="calendar-year-btn"
            class="cursor-pointer hover:bg-(--btn-plain-bg-hover) px-2 py-1.5 rounded-lg transition-colors text-lg font-bold text-neutral-900 dark:text-neutral-100 select-none"
          >
          </div>
        </div>

        <div class="flex items-center gap-1 shrink-0 ml-2">
          <button
            id="back-to-today-btn"
            class="p-1.5 rounded-md hover:bg-(--btn-plain-bg-hover) text-(--primary) transition-all invisible"
            aria-label="Back to today"
          >
            <Icon name="material-symbols:restart-alt-rounded" class="text-xl" />
          </button>
          <div
            class="flex items-center bg-(--card-bg) rounded-lg border border-neutral-200 dark:border-neutral-700"
          >
            <button
              id="prev-month-btn"
              class="p-1 px-2 hover:bg-(--btn-plain-bg-hover) text-neutral-600 dark:text-neutral-400 hover:text-(--primary) transition-colors text-sm font-bold rounded-l-lg"
              aria-label="Previous month"
            >
              ＜
            </button>
            <div
              id="calendar-month-btn"
              class="cursor-pointer hover:bg-(--btn-plain-bg-hover) px-2 py-1 transition-colors text-sm font-bold text-neutral-900 dark:text-neutral-100 select-none min-w-[3rem] text-center"
            >
            </div>
            <button
              id="next-month-btn"
              class="p-1 px-2 hover:bg-(--btn-plain-bg-hover) text-neutral-600 dark:text-neutral-400 hover:text-(--primary) transition-colors text-sm font-bold rounded-r-lg"
              aria-label="Next month"
            >
              ＞
            </button>
          </div>
        </div>
      </div>
      <div
        class="relative w-full overflow-hidden"
        style="min-height: 15.625rem;"
      >
        <div id="calendar-view" class="w-full opacity-100">
          <div class="grid grid-cols-7 gap-1 mb-2">
            {
              weekDays.map((day) => (
                <div class="text-center text-xs text-neutral-500 dark:text-neutral-400 font-medium py-1">
                  {day}
                </div>
              ))
            }
          </div>
          <div id="calendar-grid" class="grid grid-cols-7 gap-1"></div>
        </div>
        <div
          id="selection-panel"
          class="absolute inset-0 bg-(--card-bg) z-10 hidden opacity-0 transition-opacity duration-200"
        >
          <div
            id="selection-content"
            class="w-full h-full overflow-y-auto custom-scrollbar p-2 grid gap-2 content-start"
          >
          </div>
        </div>
      </div>
    </div>
  </div>
</WidgetLayout>

<script
  is:inline
  define:vars={{
    monthNames,
    yearSuffix,
    defaultExpanded,
    isChinese,
  }}
>
  // 清理旧实例，避免 SWUP 场景中重复绑定事件
  const runtimeWindow = window;
  runtimeWindow.__calendarWidgetCleanup?.();

  let allPostsData = [];
  const postDateMap = Object.create(null);
  const postsByMonth = Object.create(null);
  const postsByYear = Object.create(null);
  const stats = {
    hasPostInYear: Object.create(null),
    hasPostInMonth: Object.create(null),
    minYear: new Date().getFullYear(),
    maxYear: new Date().getFullYear() + 5,
  };
  const monthGridCache = new Map();

  let hasLoadedData = false;
  let isLoadingData = false;
  let loadError = null;
  let dataLoadPromise = null;

  async function fetchCalendarData() {
    if (hasLoadedData) {
      return true;
    }
    if (dataLoadPromise) {
      return dataLoadPromise;
    }

    dataLoadPromise = (async () => {
      isLoadingData = true;
      loadError = null;
      renderLoadState();

      try {
        let data = runtimeWindow.__calendarWidgetDataCache?.posts;

        if (!Array.isArray(data)) {
          const res = await fetch("/api/calendar-data.json");
          if (!res.ok) {
            throw new Error(`calendar-data request failed: ${res.status}`);
          }
          data = await res.json();
          if (!Array.isArray(data)) {
            throw new Error("calendar-data payload is not an array");
          }
          runtimeWindow.__calendarWidgetDataCache = { posts: data };
        }

        allPostsData = data;
        processPostsData(allPostsData);

        const currentPostId = getCurrentPostId();
        if (currentPostId) {
          const matchedPost = allPostsData.find((p) => p.id === currentPostId);
          if (matchedPost) {
            const [y, m] = matchedPost.date.split("-");
            currentYear = parseInt(y);
            currentMonth = parseInt(m) - 1;
          }
        }

        hasLoadedData = true;
        renderCalendar(true);
        return true;
      } catch (error) {
        loadError = isChinese
          ? "加载日历失败，请重试。"
          : "Failed to load calendar. Please retry.";
        console.error("[calendar] failed to fetch calendar data:", error);
        return false;
      } finally {
        isLoadingData = false;
        renderLoadState();
        dataLoadPromise = null;
      }
    })();

    return dataLoadPromise;
  }

  function resetPostIndexes() {
    for (const key of Object.keys(postDateMap)) {
      delete postDateMap[key];
    }
    for (const key of Object.keys(postsByMonth)) {
      delete postsByMonth[key];
    }
    for (const key of Object.keys(postsByYear)) {
      delete postsByYear[key];
    }
    stats.hasPostInYear = Object.create(null);
    stats.hasPostInMonth = Object.create(null);
    stats.minYear = todayYear;
    stats.maxYear = todayYear + 5;
    monthGridCache.clear();
  }

  function processPostsData(posts) {
    resetPostIndexes();
    if (!posts || posts.length === 0) {
      return;
    }
    posts.forEach((post) => {
      const [yStr, mStr] = post.date.split("-");
      const year = parseInt(yStr);
      const month = parseInt(mStr); // 1-12
      stats.hasPostInYear[year] = true;
      stats.hasPostInMonth[`${year}-${month}`] = true;

      if (year < stats.minYear) {
        stats.minYear = year;
      }
      if (year > stats.maxYear) {
        stats.maxYear = year;
      }

      const dateKey = post.date;
      const monthKey = `${year}-${month - 1}`; // JS Month is 0-11

      if (!postDateMap[dateKey]) {
        postDateMap[dateKey] = [];
      }
      postDateMap[dateKey].push(post);

      if (!postsByMonth[monthKey]) {
        postsByMonth[monthKey] = [];
      }
      postsByMonth[monthKey].push(post);

      const yearKey = String(year);
      if (!postsByYear[yearKey]) {
        postsByYear[yearKey] = [];
      }
      postsByYear[yearKey].push(post);
    });
  }

  const now = new Date();
  const todayYear = now.getFullYear();
  const todayMonth = now.getMonth();
  const todayDate = now.getDate();

  let currentYear = todayYear;
  let currentMonth = todayMonth;
  let selectedDateKey = null;
  let activeFilter = null;
  let currentView = "day";
  let isExpanded = Boolean(defaultExpanded);

  const dom = {
    toggleBtn: document.getElementById("calendar-toggle-btn"),
    toggleIcon: document.getElementById("calendar-toggle-icon"),
    body: document.getElementById("calendar-body"),
    loading: document.getElementById("calendar-loading"),
    error: document.getElementById("calendar-load-error"),
    errorText: document.getElementById("calendar-load-error-text"),
    retryBtn: document.getElementById("calendar-retry-btn"),
    content: document.getElementById("calendar-content"),
    yearBtn: document.getElementById("calendar-year-btn"),
    monthBtn: document.getElementById("calendar-month-btn"),
    prevBtn: document.getElementById("prev-month-btn"),
    nextBtn: document.getElementById("next-month-btn"),
    backTodayBtn: document.getElementById("back-to-today-btn"),
    calendarView: document.getElementById("calendar-view"),
    selectionPanel: document.getElementById("selection-panel"),
    selectionContent: document.getElementById("selection-content"),
    grid: document.getElementById("calendar-grid"),
  };

  const ac = new AbortController();
  const signal = ac.signal;

  function getCurrentPostId() {
    const path = window.location.pathname;
    if (!allPostsData || allPostsData.length === 0) {
      return null;
    }
    const decodedPath = decodeURIComponent(path);
    const normalizedPath = decodedPath.endsWith("/")
      ? decodedPath.slice(0, -1)
      : decodedPath;

    const matchedPost = allPostsData.find((post) => {
      return normalizedPath.endsWith(`/${post.id}`);
    });
    return matchedPost ? matchedPost.id : null;
  }

  function getYearLabel(year) {
    const label = `${year}${yearSuffix}`.trim();
    return label || String(year);
  }

  function getMonthLabel(year, monthIndex) {
    const yearLabel = getYearLabel(year);
    if (yearSuffix.trim().length > 0) {
      return `${yearLabel}${monthNames[monthIndex]}`.trim();
    }
    return `${yearLabel} ${monthNames[monthIndex]}`.trim();
  }

  function getMonthCacheKey(year, monthIndex) {
    return `${year}-${String(monthIndex + 1).padStart(2, "0")}`;
  }

  function emitFilterChange(detail) {
    window.dispatchEvent(new CustomEvent("calendarFilterChange", { detail }));
  }

  function emitFilterClear() {
    window.dispatchEvent(new CustomEvent("calendarFilterClear"));
  }

  function applyFilter(type, key, posts, label) {
    activeFilter = {
      type,
      key,
      posts,
      label,
    };
    if (type !== "day") {
      selectedDateKey = null;
    }
    emitFilterChange({ type, key, posts, label });
  }

  function clearFilter() {
    activeFilter = null;
    selectedDateKey = null;
    emitFilterClear();
  }

  function renderHeaderState() {
    if (dom.toggleBtn) {
      dom.toggleBtn.setAttribute("aria-expanded", String(isExpanded));
    }
    dom.toggleIcon?.classList.toggle("rotate-180", isExpanded);
    dom.body?.classList.toggle("expanded", isExpanded);
  }

  function renderLoadState() {
    const showLoading = isExpanded && isLoadingData;
    const showError = isExpanded && !isLoadingData && Boolean(loadError);
    const showContent = isExpanded && hasLoadedData && !showError;

    dom.loading?.classList.toggle("hidden", !showLoading);
    dom.error?.classList.toggle("hidden", !showError);
    dom.content?.classList.toggle("hidden", !showContent);

    if (dom.errorText && loadError) {
      dom.errorText.textContent = loadError;
    }
  }

  function updateHeaderControls() {
    if (dom.yearBtn) {
      dom.yearBtn.textContent = `${currentYear}${yearSuffix}`;
    }
    if (dom.monthBtn) {
      dom.monthBtn.textContent = monthNames[currentMonth];
    }

    const isCurrentRealMonth =
      currentYear === todayYear && currentMonth === todayMonth;
    const shouldShowReset =
      !isCurrentRealMonth || selectedDateKey !== null || activeFilter !== null;

    if (shouldShowReset) {
      dom.backTodayBtn?.classList.remove("invisible");
    } else {
      dom.backTodayBtn?.classList.add("invisible");
    }
  }

  function buildMonthGridHtml(year, monthIndex) {
    const firstDayOfMonth = (new Date(year, monthIndex, 1).getDay() + 6) % 7;
    const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();

    let html = "";
    if (firstDayOfMonth > 0) {
      html += `<div class="aspect-square"></div>`.repeat(firstDayOfMonth);
    }

    for (let day = 1; day <= daysInMonth; day++) {
      const dateKey = `${year}-${String(monthIndex + 1).padStart(2, "0")}-${String(day).padStart(2, "0")}`;
      const posts = postDateMap[dateKey] || [];
      const hasPost = posts.length > 0;
      const count = posts.length;
      const isToday =
        year === todayYear && monthIndex === todayMonth && day === todayDate;

      let stateClass = "calendar-day-default";
      if (isToday) {
        stateClass = "calendar-day-today";
      } else if (hasPost) {
        stateClass = "calendar-day-has-post";
      }

      html += `
				<div
					class="calendar-day aspect-square flex items-center justify-center rounded-md cursor-pointer relative transition-all duration-200 border border-transparent ${stateClass}"
					data-date="${dateKey}"
				>
					${day}
					<span class="calendar-day-dot absolute bottom-0 translate-y-0.5 w-1 h-1 rounded-full ${hasPost ? "opacity-100" : "opacity-0"}"></span>
					${hasPost && count > 1 ? `<span class="absolute top-0.5 right-0.5 text-[9px] opacity-70 scale-75">${count}</span>` : ""}
				</div>
			`;
    }

    return html;
  }

  function renderDayGridIfNeeded(forceRebuild = false) {
    if (!dom.grid) {
      return;
    }
    const monthKey = getMonthCacheKey(currentYear, currentMonth);
    const renderedMonthKey = dom.grid.getAttribute("data-rendered-month");

    if (!forceRebuild && renderedMonthKey === monthKey) {
      return;
    }

    let html = monthGridCache.get(monthKey);
    if (!html) {
      html = buildMonthGridHtml(currentYear, currentMonth);
      monthGridCache.set(monthKey, html);
    }

    dom.grid.innerHTML = html;
    dom.grid.setAttribute("data-rendered-month", monthKey);
  }

  function syncSelectedDayState() {
    if (!dom.grid) {
      return;
    }
    dom.grid
      .querySelectorAll(".calendar-day.is-selected")
      .forEach((cell) => cell.classList.remove("is-selected"));

    if (!selectedDateKey) {
      return;
    }
    const selectedCell = dom.grid.querySelector(
      `.calendar-day[data-date="${selectedDateKey}"]`,
    );
    selectedCell?.classList.add("is-selected");
  }

  function renderCalendar(forceGrid = false) {
    renderHeaderState();
    updateHeaderControls();

    if (!hasLoadedData) {
      renderLoadState();
      return;
    }

    renderDayGridIfNeeded(forceGrid);
    syncSelectedDayState();
    renderLoadState();
  }

  function showMonthPicker() {
    if (!hasLoadedData || !dom.selectionPanel || !dom.selectionContent) {
      return;
    }
    currentView = "month";
    updateHeaderControls();
    dom.selectionPanel.classList.add("flex", "flex-col");
    dom.selectionPanel.classList.remove("hidden");
    requestAnimationFrame(() => {
      dom.selectionPanel?.classList.remove("opacity-0");
    });

    dom.selectionContent.className =
      "w-full h-full p-4 grid grid-cols-3 gap-3 content-center justify-items-end";

    let html = "";
    monthNames.forEach((name, index) => {
      const isCurrentMonth = index === currentMonth;
      const hasPost = stats.hasPostInMonth[`${currentYear}-${index + 1}`];
      let cls =
        "month-item cursor-pointer rounded-lg flex flex-col items-center justify-center p-2 transition-all hover:bg-(--btn-plain-bg-hover) relative border border-transparent";
      if (isCurrentMonth) {
        cls += " border-(--primary) text-(--primary) bg-(--primary)/5";
      } else {
        cls += " text-neutral-700 dark:text-neutral-300";
      }

      html += `
				<div class="${cls}" data-month="${index}">
					<span class="text-sm font-bold">${name}</span>
					${hasPost ? `<span class="w-1 h-1 rounded-full bg-(--primary) mt-1"></span>` : `<span class="w-1 h-1 mt-1"></span>`}
				</div>
			`;
    });
    dom.selectionContent.innerHTML = html;
  }

  function showYearPicker() {
    if (!hasLoadedData || !dom.selectionPanel || !dom.selectionContent) {
      return;
    }
    currentView = "year";
    updateHeaderControls();
    dom.selectionPanel.classList.add("flex", "flex-col");
    dom.selectionPanel.classList.remove("hidden");
    requestAnimationFrame(() => {
      dom.selectionPanel?.classList.remove("opacity-0");
    });
    dom.selectionContent.className =
      "w-full h-full p-2 grid grid-cols-4 gap-2 content-start overflow-y-auto";

    let html = "";
    for (let y = stats.minYear; y <= stats.maxYear; y++) {
      const isCurrent = y === currentYear;
      const hasPost = stats.hasPostInYear[y];
      let cls =
        "year-item cursor-pointer rounded-lg flex flex-col items-center justify-center py-3 transition-all hover:bg-(--btn-plain-bg-hover) relative border border-transparent";
      if (isCurrent) {
        cls += " border-(--primary) text-(--primary) bg-(--primary)/5";
      } else {
        cls += " text-neutral-700 dark:text-neutral-300";
      }

      html += `
				<div class="${cls}" data-year="${y}" id="year-${y}">
					<span class="text-sm font-bold">${y}</span>
					${hasPost ? `<span class="w-1.5 h-1.5 rounded-full bg-(--primary) mt-1"></span>` : `<span class="w-1.5 h-1.5 mt-1"></span>`}
				</div>
			`;
    }
    dom.selectionContent.innerHTML = html;

    requestAnimationFrame(() => {
      const el = document.getElementById(`year-${currentYear}`);
      el?.scrollIntoView({ block: "center", behavior: "smooth" });
    });
  }

  function closeSelectionPanel(immediate = false) {
    if (!dom.selectionPanel) {
      return;
    }
    if (dom.selectionPanel.classList.contains("hidden")) {
      currentView = "day";
      return;
    }

    const finish = () => {
      dom.selectionPanel?.classList.remove("flex", "flex-col");
      dom.selectionPanel?.classList.add("hidden", "opacity-0");
      currentView = "day";
      if (isExpanded && hasLoadedData) {
        renderCalendar();
      }
    };

    if (immediate) {
      finish();
      return;
    }

    let closed = false;
    const finishOnce = () => {
      if (closed) {
        return;
      }
      closed = true;
      finish();
    };

    dom.selectionPanel.addEventListener("transitionend", finishOnce, {
      once: true,
      signal,
    });
    requestAnimationFrame(() => {
      dom.selectionPanel?.classList.add("opacity-0");
    });
    window.setTimeout(finishOnce, 240);
  }

  async function toggleExpand() {
    isExpanded = !isExpanded;
    renderHeaderState();
    renderLoadState();

    if (!isExpanded) {
      if (currentView !== "day") {
        closeSelectionPanel(true);
      }
      return;
    }

    if (!hasLoadedData) {
      await fetchCalendarData();
      return;
    }

    renderCalendar();
  }

  function setupEventListeners() {
    dom.toggleBtn?.addEventListener(
      "click",
      () => {
        void toggleExpand();
      },
      { signal },
    );

    dom.retryBtn?.addEventListener(
      "click",
      () => {
        void fetchCalendarData();
      },
      { signal },
    );

    dom.yearBtn?.addEventListener(
      "click",
      (e) => {
        e.stopPropagation();
        if (currentView === "year") {
          closeSelectionPanel();
        } else {
          showYearPicker();
        }
      },
      { signal },
    );

    dom.monthBtn?.addEventListener(
      "click",
      (e) => {
        e.stopPropagation();
        if (currentView === "month") {
          closeSelectionPanel();
        } else {
          showMonthPicker();
        }
      },
      { signal },
    );

    dom.prevBtn?.addEventListener(
      "click",
      () => {
        if (!hasLoadedData) {
          return;
        }
        if (currentView !== "day") {
          closeSelectionPanel();
        }
        if (activeFilter || selectedDateKey) {
          clearFilter();
        }
        currentMonth--;
        if (currentMonth < 0) {
          currentMonth = 11;
          currentYear--;
        }
        renderCalendar();
      },
      { signal },
    );

    dom.nextBtn?.addEventListener(
      "click",
      () => {
        if (!hasLoadedData) {
          return;
        }
        if (currentView !== "day") {
          closeSelectionPanel();
        }
        if (activeFilter || selectedDateKey) {
          clearFilter();
        }
        currentMonth++;
        if (currentMonth > 11) {
          currentMonth = 0;
          currentYear++;
        }
        renderCalendar();
      },
      { signal },
    );

    dom.backTodayBtn?.addEventListener(
      "click",
      () => {
        if (!hasLoadedData) {
          return;
        }
        currentYear = todayYear;
        currentMonth = todayMonth;
        clearFilter();
        if (currentView !== "day") {
          closeSelectionPanel();
        } else {
          renderCalendar();
        }
      },
      { signal },
    );

    dom.grid?.addEventListener(
      "click",
      (e) => {
        if (!hasLoadedData) {
          return;
        }
        const cell = e.target.closest(".calendar-day");
        if (!cell) {
          return;
        }
        const dateKey = cell.getAttribute("data-date");
        if (!dateKey) {
          return;
        }
        const posts = postDateMap[dateKey] || [];

        if (posts.length === 0) {
          clearFilter();
          renderCalendar();
          return;
        }

        if (activeFilter?.type === "day" && selectedDateKey === dateKey) {
          clearFilter();
        } else {
          selectedDateKey = dateKey;
          applyFilter("day", dateKey, posts, dateKey);
        }

        renderCalendar();
      },
      { signal },
    );

    dom.selectionContent?.addEventListener(
      "click",
      (e) => {
        if (!hasLoadedData) {
          return;
        }
        const monthItem = e.target.closest(".month-item");
        const yearItem = e.target.closest(".year-item");

        if (monthItem) {
          e.stopPropagation();
          currentMonth = parseInt(monthItem.getAttribute("data-month"));
          const monthPosts =
            postsByMonth[`${currentYear}-${currentMonth}`] || [];
          if (monthPosts.length > 0) {
            const filterKey = `${currentYear}-${String(currentMonth + 1).padStart(2, "0")}`;
            applyFilter(
              "month",
              filterKey,
              monthPosts,
              getMonthLabel(currentYear, currentMonth),
            );
          } else {
            clearFilter();
          }
          closeSelectionPanel();
        } else if (yearItem) {
          e.stopPropagation();
          currentYear = parseInt(yearItem.getAttribute("data-year"));
          const yearPosts = postsByYear[String(currentYear)] || [];
          if (yearPosts.length > 0) {
            applyFilter(
              "year",
              String(currentYear),
              yearPosts,
              getYearLabel(currentYear),
            );
          } else {
            clearFilter();
          }
          closeSelectionPanel();
        }
      },
      { signal },
    );

    document.addEventListener(
      "click",
      (e) => {
        if (currentView === "day") {
          return;
        }
        const widget = document.getElementById("calendar-widget");
        if (widget && !widget.contains(e.target)) {
          closeSelectionPanel();
        }
      },
      { signal },
    );

    window.addEventListener(
      "calendarFilterClear",
      () => {
        if (activeFilter === null && selectedDateKey === null) {
          return;
        }
        activeFilter = null;
        selectedDateKey = null;
        if (hasLoadedData) {
          renderCalendar();
        }
      },
      { signal },
    );
  }

  function init() {
    setupEventListeners();
    renderCalendar();
    if (isExpanded) {
      void fetchCalendarData();
    }
  }

  const cleanup = () => {
    ac.abort();
    if (runtimeWindow.__calendarWidgetCleanup === cleanup) {
      runtimeWindow.__calendarWidgetCleanup = undefined;
    }
  };

  runtimeWindow.__calendarWidgetCleanup = cleanup;

  init();
</script>

<style>
  .calendar-body {
    max-height: 0;
    opacity: 0;
    pointer-events: none;
    overflow: hidden;
    transition:
      max-height 240ms ease,
      opacity 180ms ease;
  }

  .calendar-body.expanded {
    max-height: 40rem;
    opacity: 1;
    pointer-events: auto;
  }

  :global(.calendar-day-default) {
    color: rgb(64 64 64);
  }

  :global(.dark .calendar-day-default) {
    color: rgb(212 212 212);
  }

  :global(.calendar-day-default:hover),
  :global(.calendar-day-has-post:hover) {
    background: var(--btn-plain-bg-hover);
  }

  :global(.calendar-day-has-post) {
    font-weight: 700;
    color: rgb(23 23 23);
  }

  :global(.dark .calendar-day-has-post) {
    color: rgb(245 245 245);
  }

  :global(.calendar-day-today) {
    font-weight: 700;
    color: var(--primary);
    background: color-mix(in oklab, var(--primary) 10%, transparent);
    border-color: var(--primary);
  }

  :global(.calendar-day-dot) {
    background: var(--primary);
  }

  :global(.calendar-day.is-selected) {
    background: var(--primary);
    color: #fff;
    box-shadow: 0 6px 16px color-mix(in oklab, var(--primary) 35%, transparent);
  }

  :global(.calendar-day.is-selected .calendar-day-dot) {
    background: #fff;
  }

  .custom-scrollbar::-webkit-scrollbar {
    width: 4px;
  }
  .custom-scrollbar::-webkit-scrollbar-track {
    background: transparent;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background-color: rgba(156, 163, 175, 0.5);
    border-radius: 2px;
  }
  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background-color: rgba(156, 163, 175, 0.8);
  }
</style>
