---
import { widgetManager } from "../utils/widget-manager";
import { formatDateToYYYYMMDD } from "../utils/date-utils";
import type { DirectusPostEntry } from "@/utils/content-utils";
import { resolveAuthorIdentity } from "@/utils/author-identity";

import PostCard from "./PostCard.astro";

interface PostListPage {
  data: DirectusPostEntry[];
}

interface Props {
  page: PostListPage;
  maxAnimationIndex?: number;
}

const { page, maxAnimationIndex } = Astro.props;

// 检查是否启用右侧边栏（通过检查右侧是否有组件）
const hasRightSidebars =
  widgetManager.getComponentsByPosition("top", "right", "desktop").length > 0 ||
  widgetManager.getComponentsByPosition("sticky", "right", "desktop").length >
    0;

const initialLayoutClass = "list-mode";
---

<div
  id="post-list-container"
  class={`transition-all duration-500 ease-in-out rounded-(--radius-large) bg-(--card-bg) md:bg-transparent mb-4 ${initialLayoutClass}`}
  data-both-sidebars={hasRightSidebars}
>
  {
    page.data.map((entry, index) => {
      const date = formatDateToYYYYMMDD(entry.data.published);
      const [year, month] = date.split("-");
      const monthKey = `${year}-${month}`;
      const { username: authorHandle } = resolveAuthorIdentity(
        {
          id: entry.data.author?.id,
          name: entry.data.author?.name,
          username: entry.data.author?.username,
          display_name: entry.data.author?.display_name,
        },
        entry.data.author_id,
      );
      return (
        <div
          class="post-list-item"
          data-year={year}
          data-month={monthKey}
          data-day={date}
          data-tags={JSON.stringify(entry.data.tags || [])}
          data-category={entry.data.category || ""}
          data-author-id={entry.data.author_id}
          data-author-handle={authorHandle}
        >
          <PostCard
            entry={entry}
            class:list="onload-animation"
            style={`--i: ${maxAnimationIndex !== undefined ? Math.min(index, maxAnimationIndex) : index}; --interval: 50ms;`}
          />
        </div>
      );
    })
  }
</div>

<script>
  import { initPostInteractions } from "@/scripts/post-interactions";

  initPostInteractions();
</script>

<style>
  @reference "../styles/main.css";

  /* 基础容器 */
  #post-list-container {
    min-height: 200px;
    transition: opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* 布局模式 - 列表模式 */
  #post-list-container.list-mode {
    @apply flex flex-col gap-4;
  }

  /* 内容可见性 (视口外不渲染) */
  #post-list-container > :global(*) {
    content-visibility: auto;
    contain-intrinsic-size: 200px;
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    opacity: 0;
    animation: fadeInSlide 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
    animation-delay: calc(var(--content-delay) + var(--i) * var(--interval));
  }

  @keyframes fadeInSlide {
    from {
      opacity: 0;
      transform: translateX(-10px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }
</style>
