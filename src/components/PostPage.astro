---
import type { CollectionEntry } from "astro:content";
import type { Page } from "astro";
import { widgetManager } from "../utils/widget-manager";
import { formatDateToYYYYMMDD } from "../utils/date-utils";
import PostCard from "./PostCard.astro";

interface Props {
	page: Page<CollectionEntry<"posts">>;
}

const { page } = Astro.props;

// 检查是否启用右侧边栏（通过检查右侧是否有组件）
const hasRightSidebars =
	widgetManager.getComponentsByPosition("top", "right", "desktop").length > 0 ||
	widgetManager.getComponentsByPosition("sticky", "right", "desktop").length > 0;

const initialLayoutClass = "list-mode";
---

<div
	id="post-list-container"
	class={`transition-all duration-500 ease-in-out rounded-[var(--radius-large)] bg-[var(--card-bg)] md:bg-transparent mb-4 ${initialLayoutClass}`}
	data-both-sidebars={hasRightSidebars}
>
	{
		page.data.map((entry, index) => {
			const date = formatDateToYYYYMMDD(entry.data.published);
			const [year, month] = date.split("-");
			const monthKey = `${year}-${month}`;
			return (
				<div
					class="post-list-item"
					data-year={year}
					data-month={monthKey}
					data-day={date}
				>
					<PostCard
						entry={entry}
						class:list="onload-animation"
						style={`--i: ${index}; --interval: 50ms;`}
					/>
				</div>
			);
		})
	}
</div>

<script>
	// 日历筛选逻辑
	type CalendarFilterDetail = {
		type: "day" | "month" | "year";
		key: string;
		posts: Array<{
			id: string;
			title: string;
			date: string;
			url: string;
		}>;
	};

	function getFilterDom() {
		return {
			postList: document.getElementById("post-list-container"),
			pagination: document.getElementById("pagination-container"),
		};
	}

	function applyCalendarFilter(detail: CalendarFilterDetail) {
		const { postList, pagination } = getFilterDom();
		if (!postList) {return;}
		const items = Array.from(
			postList.querySelectorAll<HTMLElement>(".post-list-item"),
		);
		items.forEach((item) => {
			const match =
				detail.type === "year"
					? item.dataset.year === detail.key
					: detail.type === "month"
						? item.dataset.month === detail.key
						: item.dataset.day === detail.key;
			item.classList.toggle("hidden", !match);
		});
		pagination?.classList.add("hidden");
	}

	function clearCalendarFilter() {
		const { postList, pagination } = getFilterDom();
		if (!postList) {return;}
		postList
			.querySelectorAll<HTMLElement>(".post-list-item.hidden")
			.forEach((item) => item.classList.remove("hidden"));
		pagination?.classList.remove("hidden");
	}

	function setupCalendarFilterListeners() {
		if (window._calendarFilterListenerAttached) {return;}

		window.addEventListener("calendarFilterChange", (event) => {
			const detail = (event as CustomEvent<CalendarFilterDetail>).detail;
			if (!detail || !Array.isArray(detail.posts)) {return;}
			applyCalendarFilter(detail);
		});

		window.addEventListener("calendarFilterClear", () => {
			clearCalendarFilter();
		});

		window._calendarFilterListenerAttached = true;
	}

	setupCalendarFilterListeners();
</script>

<style>
	/* 基础容器 */
	#post-list-container {
		min-height: 200px;
		transition: opacity 0.5s cubic-bezier(0.4, 0, 0.2, 1);
	}

	/* 布局模式 - 列表模式 */
	#post-list-container.list-mode {
		@apply flex flex-col gap-4;
	}

	/* 内容可见性 (视口外不渲染) */
	#post-list-container > :global(*) {
		content-visibility: auto;
		contain-intrinsic-size: 200px;
		transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
		opacity: 0;
		animation: fadeInSlide 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards;
		animation-delay: calc(
			var(--content-delay) + var(--i) * var(--interval)
		);
	}

	@keyframes fadeInSlide {
		from {
			opacity: 0;
			transform: translateX(-10px);
		}
		to {
			opacity: 1;
			transform: translateX(0);
		}
	}
</style>
