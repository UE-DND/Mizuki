---
import { Icon } from "astro-icon/components";
import { siteConfig } from "../config";
import I18nKey from "../i18n/i18nKey";
import { i18n } from "../i18n/translation";
import MainGridLayout from "../layouts/MainGridLayout.astro";
import {
	getCategoryList,
	getSortedPosts,
	getTagList,
} from "../utils/content-utils";

export const prerender = false;

const title = i18n(I18nKey.siteStats);

// 从配置中获取站点开始日期
const siteStartDate = siteConfig.siteStartDate || "2025-01-01";

// 获取所有文章
const posts = await getSortedPosts();
const categories = await getCategoryList();
const tags = await getTagList();

// 计算总字数
let totalWords = 0;
for (const post of posts) {
	if (post.body) {
		let text = post.body;

		// 移除代码块
		text = text.replace(/```[\s\S]*?```/g, "");
		// 移除 ` 包裹的行内代码
		text = text.replace(/`[^`]+`/g, "");

		// 使用与 remark-content.mjs 完全一致的 CJK 正则
		const cjkPattern =
			/[\u4e00-\u9fa5\u3040-\u309f\u30a0-\u30ff\uac00-\ud7af\u3000-\u303f\uff00-\uffef]/g;

		const cjkMatches = text.match(cjkPattern);
		const cjkCount = cjkMatches ? cjkMatches.length : 0;

		// 计算非 CJK 单词数
		const nonCjkText = text.replace(cjkPattern, " ");

		// 按空白字符分割，计算单词数量
		const nonCjkWords = nonCjkText
			.split(/\s+/)
			.filter((word: string) => word.trim().length > 0);

		totalWords += cjkCount + nonCjkWords.length;
	}
}

// 格式化数字（添加千位分隔符）
function formatNumber(num: number): string {
	return num.toLocaleString();
}

// 获取最新文章日期（忽略置顶状态，只按发布日期排序）
const latestPost = posts.reduce(
	(latest: (typeof posts)[number] | undefined, post: (typeof posts)[number]) => {
		if (!latest) {return post;}
		return post.data.published > latest.data.published ? post : latest;
	},
	posts[0],
);

const lastPostDate = latestPost
	? latestPost.data.published.toISOString()
	: null;

const stats = [
	{
		icon: "material-symbols:article-outline",
		label: i18n(I18nKey.siteStatsPostCount),
		value: posts.length,
	},
	{
		icon: "material-symbols:folder-outline",
		label: i18n(I18nKey.siteStatsCategoryCount),
		value: categories.length,
	},
	{
		icon: "material-symbols:label-outline",
		label: i18n(I18nKey.siteStatsTagCount),
		value: tags.length,
	},
	{
		icon: "material-symbols:text-ad-outline-rounded",
		label: i18n(I18nKey.siteStatsTotalWords),
		value: totalWords,
		formatted: true,
	},
	{
		icon: "material-symbols:calendar-clock-outline",
		label: i18n(I18nKey.siteStatsRunningDays),
		value: 0,
		suffix: i18n(I18nKey.siteStatsDays).replace("{days}", ""),
		dynamic: true,
		id: "running-days",
	},
	{
		icon: "material-symbols:ecg-heart-outline",
		label: i18n(I18nKey.siteStatsLastUpdate),
		value: 0,
		suffix: i18n(I18nKey.siteStatsDaysAgo).replace("{days}", ""),
		dynamic: true,
		id: "last-update",
	},
];
---

<MainGridLayout title={title}>
	<script>
		import("../scripts/right-sidebar-layout.js");
	</script>
	<div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative min-h-32">
		<div class="card-base z-10 px-9 py-6 relative w-full">
			<div class="flex flex-col items-start justify-center mb-8">
				<h1 class="text-4xl font-bold text-black/90 dark:text-white/90 mb-2 relative
                          before:w-1 before:h-8 before:rounded-md before:bg-[var(--primary)]
                          before:absolute before:top-1/2 before:-translate-y-1/2 before:-left-4">
					{title}
				</h1>
			</div>

			<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
				{
					stats.map((stat) => (
						<div class="flex items-center gap-4 p-5 rounded-xl
									bg-[var(--btn-regular-bg)] border border-black/5 dark:border-white/5
									transition-all duration-200 hover:shadow-md hover:-translate-y-0.5">
							<div class="flex items-center justify-center w-12 h-12 rounded-lg
										bg-[var(--primary)]/10 text-[var(--primary)] text-2xl shrink-0">
								<Icon name={stat.icon} />
							</div>
							<div class="flex flex-col min-w-0">
								<span class="text-sm text-neutral-500 dark:text-neutral-400">
									{stat.label}
								</span>
								<div class="flex items-baseline gap-1">
									<span
										class="text-2xl font-bold text-neutral-900 dark:text-neutral-100"
										data-stat-id={stat.id}
									>
										{stat.formatted
											? formatNumber(stat.value)
											: stat.value}
									</span>
									{stat.suffix && (
										<span class="text-sm text-neutral-400 dark:text-neutral-500">
											{stat.suffix}
										</span>
									)}
								</div>
							</div>
						</div>
					))
				}
			</div>
		</div>
	</div>
</MainGridLayout>

<script is:inline define:vars={{ siteStartDate, lastPostDate }}>
	function updateDynamicStats() {
		const today = new Date();

		// 更新运行天数
		const startDate = new Date(siteStartDate);
		const diffTime = Math.abs(today.getTime() - startDate.getTime());
		const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

		const runningDaysElements = document.querySelectorAll(
			'[data-stat-id="running-days"]',
		);
		if (runningDaysElements.length > 0) {
			runningDaysElements.forEach((element) => {
				element.textContent = diffDays.toString();
			});
		}

		// 更新最近更新时间
		if (lastPostDate) {
			const lastPost = new Date(lastPostDate);
			const timeSinceLastPost = Math.abs(
				today.getTime() - lastPost.getTime(),
			);
			const daysSinceLastUpdate = Math.floor(
				timeSinceLastPost / (1000 * 60 * 60 * 24),
			);

			const lastUpdateElements = document.querySelectorAll(
				'[data-stat-id="last-update"]',
			);
			if (lastUpdateElements.length > 0) {
				lastUpdateElements.forEach((element) => {
					element.textContent = daysSinceLastUpdate.toString();
				});
			}
		}
	}

	// 页面加载时更新
	updateDynamicStats();

	// 每小时更新一次
	setInterval(updateDynamicStats, 60 * 60 * 1000);
</script>
