---
import ContentNotVisible from "@components/misc/ContentNotVisible.astro";
import MainGridLayout from "@layouts/MainGridLayout.astro";
import { buildDirectusAssetUrl } from "@/server/directus-auth";
import {
	loadProfileForViewer,
	loadUserAlbumList,
	profileToSidebarData,
} from "@/server/api/v1/public-data";
import type { ContentLoadResult, PaginatedResult } from "@/server/api/v1/public-data";
import { getSessionUser } from "@/server/auth/session";

export const prerender = false;

const username = (Astro.params.username || "").trim();

type AlbumListItem = {
	id: string;
	short_id: string | null;
	title: string;
	description: string | null;
	cover_file: string | null;
	cover_url: string | null;
	date: string | null;
	location: string | null;
	tags: string[];
	author?: { name?: string };
};

let result: ContentLoadResult<PaginatedResult<AlbumListItem>> = { status: "not_found" };

try {
	if (!username) {
		Astro.response.status = 404;
	} else {
		const sessionUser = await getSessionUser(Astro);
		const viewerId = sessionUser?.id ?? null;
		result = await loadUserAlbumList(username, { limit: 100, viewerId }) as ContentLoadResult<PaginatedResult<AlbumListItem>>;
		if (result.status === "not_found") {
			Astro.response.status = 404;
		} else if (result.status === "permission_denied") {
			Astro.response.status = 403;
		} else {
			const sidebarProfile = await loadProfileForViewer(username, viewerId);
			if (sidebarProfile) {
				Astro.locals.sidebarProfile = profileToSidebarData(sidebarProfile);
			}
		}
	}
} catch (error) {
	console.error("[albums] failed to load entries:", error);
	Astro.response.status = 500;
}

const items = result.status === "ok" ? result.data.items : [];

function coverUrl(item: {
	cover_file: string | null;
	cover_url: string | null;
}): string | null {
	if (item.cover_url) {
		return item.cover_url;
	}
	if (item.cover_file) {
		return buildDirectusAssetUrl(item.cover_file, {
			width: 960,
			height: 640,
			fit: "cover",
		});
	}
	return null;
}
---

<MainGridLayout title="相册" description="用户公开相册列表">
	{result.status === "permission_denied" ? (
		<ContentNotVisible
			mode="permission_denied"
			title="相册不可见"
			description="由于用户权限设置，该用户的相册内容不可见。"
			backHref={`/${username}`}
			backLabel="返回用户主页"
		/>
	) : result.status === "not_found" ? (
		<ContentNotVisible
			mode="not_found"
			title="用户不存在"
			description="该用户不存在或链接错误。"
			backHref="/"
			backLabel="返回首页"
		/>
	) : (
		<>
			<section class="card-base px-9 py-6 rounded-[var(--radius-large)] mb-4 text-90">
				<h1 class="text-4xl font-bold text-black/90 dark:text-white/90 mb-2 relative
					before:w-1 before:h-8 before:rounded-md before:bg-[var(--primary)]
					before:absolute before:top-1/2 before:-translate-y-1/2 before:-left-4">相册</h1>
				<p class="text-base text-70">用户公开的相册内容。</p>
			</section>

			{items.length === 0 ? (
				<div class="card-base p-8 rounded-[var(--radius-large)] text-70">暂无公开相册。</div>
			) : (
				<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
					{items.map((item) => (
						<article class="card-base rounded-[var(--radius-large)] overflow-hidden border border-[var(--line-divider)] text-90">
							<a href={`/${username}/albums/${item.short_id || item.id}`} class="block h-full">
								{coverUrl(item) && (
									<img
										src={coverUrl(item) || ""}
										alt={item.title}
										class="w-full h-48 object-cover"
										loading="lazy"
									/>
								)}
								<div class="p-4 space-y-2">
									<h2 class="text-lg font-semibold line-clamp-1">{item.title}</h2>
									<div class="text-xs text-60 flex flex-wrap items-center gap-2">
										{item.author?.name && <span>作者：{item.author.name}</span>}
										{item.date && <span>{item.date}</span>}
										{item.location && <span>{item.location}</span>}
									</div>
									{item.description && <p class="text-sm text-75 line-clamp-2">{item.description}</p>}
									{item.tags.length > 0 && (
										<div class="flex flex-wrap gap-2 pt-1">
											{item.tags.slice(0, 4).map((tag) => (
												<span class="btn-regular h-6 text-xs px-2 rounded-lg">#{tag}</span>
											))}
										</div>
									)}
								</div>
							</a>
						</article>
					))}
				</div>
			)}
		</>
	)}
</MainGridLayout>
