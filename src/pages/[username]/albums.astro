---
import MainGridLayout from "@layouts/MainGridLayout.astro";
import { buildDirectusAssetUrl } from "@/server/directus-auth";
import {
	loadPublicProfileByUsername,
	loadUserAlbumList,
	profileToSidebarData,
} from "@/server/api/v1/public-data";

export const prerender = false;

const username = (Astro.params.username || "").trim();
let items: Array<{
	id: string;
	title: string;
	description: string | null;
	cover_file: string | null;
	cover_url: string | null;
	date: string | null;
	location: string | null;
	tags: string[];
	author?: { name?: string };
}> = [];

try {
	if (!username) {
		Astro.response.status = 404;
	} else {
		const result = await loadUserAlbumList(username, { limit: 100 });
		if (result) {
			items = result.items;
			const sidebarProfile = await loadPublicProfileByUsername(username);
			if (sidebarProfile) {
				Astro.locals.sidebarProfile = profileToSidebarData(sidebarProfile);
			}
		} else {
			Astro.response.status = 404;
		}
	}
} catch (error) {
	console.error("[albums] failed to load entries:", error);
	Astro.response.status = 500;
}

function coverUrl(item: {
	cover_file: string | null;
	cover_url: string | null;
}): string | null {
	if (item.cover_url) {
		return item.cover_url;
	}
	if (item.cover_file) {
		return buildDirectusAssetUrl(item.cover_file, {
			width: 960,
			height: 640,
			fit: "cover",
		});
	}
	return null;
}
---

<MainGridLayout title="相册" description="用户公开相册列表">
	<section class="card-base p-6 rounded-[var(--radius-large)] mb-4 text-90">
		<h1 class="text-2xl font-bold mb-2">相册</h1>
		<p class="text-sm text-70">用户公开的相册内容。</p>
	</section>

	{items.length === 0 ? (
		<div class="card-base p-8 rounded-[var(--radius-large)] text-70">暂无公开相册。</div>
	) : (
		<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
			{items.map((item) => (
				<article class="card-base rounded-[var(--radius-large)] overflow-hidden border border-[var(--line-divider)] text-90">
					<a href={`/${username}/albums/${item.id}`} class="block h-full">
						{coverUrl(item) && (
							<img
								src={coverUrl(item) || ""}
								alt={item.title}
								class="w-full h-48 object-cover"
								loading="lazy"
							/>
						)}
						<div class="p-4 space-y-2">
							<h2 class="text-lg font-semibold line-clamp-1">{item.title}</h2>
							<div class="text-xs text-60 flex flex-wrap items-center gap-2">
								{item.author?.name && <span>作者：{item.author.name}</span>}
								{item.date && <span>{item.date}</span>}
								{item.location && <span>{item.location}</span>}
							</div>
							{item.description && <p class="text-sm text-75 line-clamp-2">{item.description}</p>}
							{item.tags.length > 0 && (
								<div class="flex flex-wrap gap-2 pt-1">
									{item.tags.slice(0, 4).map((tag) => (
										<span class="btn-regular h-6 text-xs px-2 rounded-lg">#{tag}</span>
									))}
								</div>
							)}
						</div>
					</a>
				</article>
			))}
		</div>
	)}
</MainGridLayout>
