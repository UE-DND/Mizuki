---
import MainGridLayout from "@layouts/MainGridLayout.astro";
import { buildDirectusAssetUrl } from "@/server/directus-auth";
import { loadUserAnimeList } from "@/server/api/v1/public-data";

export const prerender = false;

const username = (Astro.params.username || "").trim();
let items: Array<{
	id: string;
	title: string;
	watch_status: string;
	rating: number | null;
	progress: number | null;
	total_episodes: number | null;
	year: string | null;
	studio: string | null;
	genres: string[];
	description: string | null;
	link: string | null;
	cover_file: string | null;
	cover_url: string | null;
	author?: { name?: string };
}> = [];

try {
	if (!username) {
		Astro.response.status = 404;
	} else {
		const result = await loadUserAnimeList(username, { limit: 200 });
		if (result) {
			items = result.items;
		} else {
			Astro.response.status = 404;
		}
	}
} catch (error) {
	console.error("[anime] failed to load entries:", error);
	Astro.response.status = 500;
}

function coverUrl(item: {
	cover_file: string | null;
	cover_url: string | null;
}): string | null {
	if (item.cover_url) {
		return item.cover_url;
	}
	if (item.cover_file) {
		return buildDirectusAssetUrl(item.cover_file, {
			width: 640,
			height: 900,
			fit: "cover",
		});
	}
	return null;
}

function statusLabel(status: string): string {
	switch (status) {
		case "watching":
			return "在看";
		case "completed":
			return "看完";
		case "planned":
			return "计划看";
		case "onhold":
			return "搁置";
		case "dropped":
			return "弃番";
		default:
			return status || "未知";
	}
}
---

<MainGridLayout title="番剧" description="用户公开番剧列表">
	<section class="card-base p-6 rounded-[var(--radius-large)] mb-4">
		<h1 class="text-2xl font-bold mb-2">番剧</h1>
		<p class="text-sm text-70">用户公开的番剧条目。</p>
	</section>

	{items.length === 0 ? (
		<div class="card-base p-8 rounded-[var(--radius-large)] text-70">暂无公开番剧条目。</div>
	) : (
		<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
			{items.map((item) => (
				<article class="card-base p-4 rounded-[var(--radius-large)] border border-[var(--line-divider)] h-full">
					<div class="flex gap-4 h-full">
						{coverUrl(item) && (
							<img src={coverUrl(item) || ""} alt={item.title} class="w-24 h-32 rounded-lg object-cover border border-[var(--line-divider)] shrink-0" loading="lazy" />
						)}
						<div class="min-w-0 space-y-2 flex-1">
							<h2 class="text-lg font-semibold line-clamp-2">{item.title}</h2>
							<div class="text-xs text-60 flex flex-wrap gap-2">
								<span>{statusLabel(item.watch_status)}</span>
								{item.author?.name && <span>作者：{item.author.name}</span>}
								{item.year && <span>{item.year}</span>}
							</div>
							<div class="text-xs text-70">
								进度：{item.progress ?? 0}/{item.total_episodes ?? "?"}
								{typeof item.rating === "number" && <span class="ml-2">评分：{item.rating}</span>}
							</div>
							{item.description && <p class="text-sm text-75 line-clamp-3">{item.description}</p>}
							{item.genres.length > 0 && (
								<div class="flex flex-wrap gap-2">
									{item.genres.slice(0, 4).map((genre) => (
										<span class="btn-regular h-6 text-xs px-2 rounded-lg">{genre}</span>
									))}
								</div>
							)}
							{item.link && (
								<a href={item.link} target="_blank" rel="noopener noreferrer" class="text-xs text-[var(--primary)] hover:underline">
									查看链接
								</a>
							)}
						</div>
					</div>
				</article>
			))}
		</div>
	)}
</MainGridLayout>
