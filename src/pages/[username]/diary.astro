---
import ContentNotVisible from "@components/misc/ContentNotVisible.astro";
import DiaryCard from "@components/DiaryCard.astro";
import MainGridLayout from "@layouts/MainGridLayout.astro";
import {
  loadProfileForViewer,
  loadUserDiaryList,
  profileToSidebarData,
} from "@/server/api/v1/public-data";
import type {
  ContentLoadResult,
  PaginatedResult,
} from "@/server/api/v1/public-data";
import type { AppDiary, AppDiaryImage } from "@/types/app";
import type { AuthorBundleItem } from "@/server/api/v1/shared/author-cache";
import { getSessionUser } from "@/server/auth/session";

export const prerender = false;

const username = (Astro.params.username || "").trim();

type DiaryListItem = AppDiary & {
  author: AuthorBundleItem;
  images: AppDiaryImage[];
  comment_count: number;
  like_count: number;
};

let result: ContentLoadResult<PaginatedResult<DiaryListItem>> = {
  status: "not_found",
};

try {
  if (!username) {
    Astro.response.status = 404;
  } else {
    const sessionUser = await getSessionUser(Astro);
    const viewerId = sessionUser?.id ?? null;
    result = (await loadUserDiaryList(username, {
      limit: 100,
      viewerId,
    })) as ContentLoadResult<PaginatedResult<DiaryListItem>>;
    if (result.status === "not_found") {
      Astro.response.status = 404;
    } else if (result.status === "permission_denied") {
      Astro.response.status = 403;
    } else {
      const sidebarProfile = await loadProfileForViewer(username, viewerId);
      if (sidebarProfile) {
        Astro.locals.sidebarProfile = profileToSidebarData(sidebarProfile);
      }
    }
  }
} catch (error) {
  console.error("[diary] failed to load entries:", error);
  Astro.response.status = 500;
}

const items = result.status === "ok" ? result.data.items : [];
---

<MainGridLayout title="日记" description="用户公开日记列表">
  {
    result.status === "permission_denied" ? (
      <ContentNotVisible
        mode="permission_denied"
        title="日记不可见"
        description="由于用户权限设置，该用户的日记内容不可见。"
        backHref={`/${username}`}
        backLabel="返回用户主页"
      />
    ) : result.status === "not_found" ? (
      <ContentNotVisible
        mode="not_found"
        title="用户不存在"
        description="该用户不存在或链接错误。"
        backHref="/"
        backLabel="返回首页"
      />
    ) : (
      <div
        data-enter-skeleton-page="user-diary"
        data-enter-skeleton-target="user-diary"
      >
        <div data-enter-skeleton-inline-content>
          <section class="card-base px-9 py-6 rounded-(--radius-large) mb-4 text-90">
            <h1
              class="text-4xl font-bold text-black/90 dark:text-white/90 mb-2 relative
					before:w-1 before:h-8 before:rounded-md before:bg-(--primary)
					before:absolute before:top-1/2 before:-translate-y-1/2 before:-left-4"
            >
              日记
            </h1>
            <p class="text-base text-70">我的公开日记</p>
          </section>

          {items.length === 0 ? (
            <div class="card-base p-8 rounded-(--radius-large) text-70">
              暂无公开日记。
            </div>
          ) : (
            <div class="space-y-4">
              {items.map((item) => (
                <div class="diary-list-item">
                  <DiaryCard entry={item} username={username} />
                </div>
              ))}
            </div>
          )}
        </div>
        <div
          data-enter-skeleton-inline-placeholder
          aria-hidden="true"
          class="space-y-4"
        >
          <section class="card-base px-9 py-6 rounded-(--radius-large) mb-4">
            <div class="space-y-3">
              <div
                class="md3-skeleton-text"
                style="--skeleton-width: 24%; --skeleton-height: 2rem;"
              />
              <div
                class="md3-skeleton-text"
                style="--skeleton-width: 44%; --skeleton-height: 0.92rem;"
              />
            </div>
          </section>
          <div class="space-y-4">
            {Array.from({ length: 3 }).map(() => (
              <article class="card-base flex flex-col w-full rounded-(--radius-large) overflow-hidden">
                <div class="pl-6 md:pl-9 pr-6 md:pr-2 pt-6 md:pt-7 pb-6 space-y-4">
                  <div>
                    <div
                      class="md3-skeleton-text"
                      style="--skeleton-width: 44%; --skeleton-height: 2rem;"
                    />
                  </div>
                  <div class="grid grid-cols-3 md:grid-cols-4 gap-2">
                    <div class="md3-skeleton-block h-20 md:h-24 rounded-lg" />
                    <div class="md3-skeleton-block h-20 md:h-24 rounded-lg" />
                  </div>
                  <div class="flex items-center justify-between gap-3 mt-4">
                    <div class="flex items-center gap-1.5 min-w-0">
                      <div
                        class="md3-skeleton-text"
                        style="--skeleton-width: 10.5rem; --skeleton-height: 1.45rem;"
                      />
                      <div class="md3-skeleton-circle h-1.5 w-1.5" />
                      <div
                        class="md3-skeleton-text"
                        style="--skeleton-width: 7.5rem; --skeleton-height: 1.45rem;"
                      />
                    </div>
                    <div class="flex items-center gap-3 md:gap-4">
                      <div class="md3-skeleton-block h-6 w-8 rounded-lg" />
                      <div class="md3-skeleton-block h-6 w-8 rounded-lg" />
                      <div class="md3-skeleton-circle h-6 w-6 rounded-lg" />
                    </div>
                  </div>
                </div>
              </article>
            ))}
          </div>
        </div>
      </div>
    )
  }
</MainGridLayout>

<script>
  import { initPostInteractions } from "@/scripts/post-interactions";
  initPostInteractions();
</script>
