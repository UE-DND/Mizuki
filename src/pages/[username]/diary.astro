---
import MainGridLayout from "@layouts/MainGridLayout.astro";
import { loadUserDiaryList } from "@/server/api/v1/public-data";

export const prerender = false;

const username = (Astro.params.username || "").trim();
let items: Array<{
	id: string;
	content: string;
	mood: string | null;
	location: string | null;
	happened_at: string | null;
	author?: { name?: string };
	images?: Array<{ image_url: string | null }>;
}> = [];

try {
	if (!username) {
		Astro.response.status = 404;
	} else {
		const result = await loadUserDiaryList(username, { limit: 100 });
		if (result) {
			items = result.items;
		} else {
			Astro.response.status = 404;
		}
	}
} catch (error) {
	console.error("[diary] failed to load entries:", error);
	Astro.response.status = 500;
}

function shortText(input: string): string {
	const text = String(input || "").replace(/\s+/g, " ").trim();
	if (text.length <= 180) {
		return text;
	}
	return `${text.slice(0, 180)}...`;
}
---

<MainGridLayout title="日记" description="用户公开日记列表">
	<section class="card-base p-6 rounded-[var(--radius-large)] mb-4 text-90">
		<h1 class="text-2xl font-bold mb-2">日记</h1>
		<p class="text-sm text-70">用户公开的日记内容。</p>
	</section>

	{items.length === 0 ? (
		<div class="card-base p-8 rounded-[var(--radius-large)] text-70">暂无公开日记。</div>
	) : (
		<div class="space-y-4">
			{items.map((item) => (
				<article class="card-base p-5 rounded-[var(--radius-large)] border border-[var(--line-divider)] text-90">
					<a href={`/${username}/diary/${item.id}/`} class="block space-y-3">
						<div class="flex flex-wrap items-center gap-3 text-xs text-60">
							{item.author?.name && <span>作者：{item.author.name}</span>}
							{item.happened_at && <time datetime={item.happened_at}>{new Date(item.happened_at).toLocaleString()}</time>}
							{item.location && <span>地点：{item.location}</span>}
							{item.mood && <span>心情：{item.mood}</span>}
						</div>
						<p class="text-sm md:text-base text-85 leading-7">{shortText(item.content)}</p>
						{Array.isArray(item.images) && item.images.length > 0 && (
							<div class="grid grid-cols-3 md:grid-cols-4 gap-2">
								{item.images
									.filter((image) => image.image_url)
									.slice(0, 4)
									.map((image) => (
										<img
											src={image.image_url || ""}
											alt="日记配图"
											class="w-full h-20 md:h-24 object-cover rounded-lg border border-[var(--line-divider)]"
											loading="lazy"
										/>
									))}
							</div>
						)}
					</a>
				</article>
			))}
		</div>
	)}
</MainGridLayout>
