---
import MainGridLayout from "@layouts/MainGridLayout.astro";
import { buildDirectusAssetUrl } from "@/server/directus-auth";
import { loadUserAlbumDetail } from "@/server/api/v1/public-data";

export const prerender = false;

const username = (Astro.params.username || "").trim();
const id = (Astro.params.id || "").trim();

type AlbumPageData = {
	id: string;
	title: string;
	slug: string;
	description: string | null;
	cover_file: string | null;
	cover_url: string | null;
	date: string | null;
	location: string | null;
	tags: string[];
	layout: "grid" | "masonry";
	columns: number;
	author?: { name?: string; username?: string };
	photos: Array<{
		id: string;
		file_id: string | null;
		image_url: string | null;
		title: string | null;
		description: string | null;
		tags: string[];
		location: string | null;
	}>;
};

let album: AlbumPageData | null = null;

if (!username || !id) {
	Astro.response.status = 404;
} else {
	try {
		const result = await loadUserAlbumDetail(username, id);
		if (result) {
			album = result as AlbumPageData;
		} else {
			Astro.response.status = 404;
		}
	} catch (error) {
		console.error("[albums] failed to load detail:", error);
		Astro.response.status = 500;
	}
}

const backHref = username ? `/${username}/albums/` : "/";

function photoUrl(photo: { file_id: string | null; image_url: string | null }): string | null {
	if (photo.image_url) {
		return photo.image_url;
	}
	if (photo.file_id) {
		return buildDirectusAssetUrl(photo.file_id, {
			width: 1200,
			height: 900,
			fit: "cover",
		});
	}
	return null;
}
---

<MainGridLayout title={album?.title || "相册不存在"} description={album?.description || ""}>
	{!album ? (
		<div class="card-base p-8 rounded-[var(--radius-large)]">
			<h1 class="text-2xl font-bold mb-2">相册不存在</h1>
			<p class="text-70">该相册可能未公开或已删除。</p>
		</div>
	) : (
		<>
			<section class="card-base p-6 rounded-[var(--radius-large)] mb-4 space-y-3">
				<a href={backHref} class="text-sm text-[var(--primary)] hover:underline">返回相册列表</a>
				<h1 class="text-3xl font-bold">{album.title}</h1>
				<div class="text-xs text-60 flex flex-wrap items-center gap-2">
					{album.author?.name && <span>作者：{album.author.name}</span>}
					{album.date && <span>{album.date}</span>}
					{album.location && <span>{album.location}</span>}
				</div>
				{album.description && <p class="text-75">{album.description}</p>}
				{album.tags.length > 0 && (
					<div class="flex flex-wrap gap-2">
						{album.tags.map((tag) => (
							<span class="btn-regular h-7 text-xs px-3 rounded-lg">#{tag}</span>
						))}
					</div>
				)}
			</section>

			{album.photos.length === 0 ? (
				<div class="card-base p-8 rounded-[var(--radius-large)] text-70">该相册暂无可展示照片。</div>
			) : (
				<div
					class:list={[
						"gap-3",
						album.layout === "masonry" ? "columns-2 md:columns-3" : "grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4",
					]}
				>
					{album.photos.map((photo) => (
						<figure class:list={["rounded-xl overflow-hidden border border-[var(--line-divider)] bg-[var(--card-bg)]", album.layout === "masonry" ? "mb-3 break-inside-avoid" : ""]}>
							{photoUrl(photo) && (
								<img src={photoUrl(photo) || ""} alt={photo.title || "album photo"} class="w-full h-auto object-cover" loading="lazy" />
							)}
							{(photo.title || photo.description) && (
								<figcaption class="p-3 space-y-1">
									{photo.title && <div class="text-sm font-medium">{photo.title}</div>}
									{photo.description && <div class="text-xs text-60">{photo.description}</div>}
								</figcaption>
							)}
						</figure>
					))}
				</div>
			)}
		</>
	)}
</MainGridLayout>
