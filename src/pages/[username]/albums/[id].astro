---
import ContentNotVisible from "@components/misc/ContentNotVisible.astro";
import MainGridLayout from "@layouts/MainGridLayout.astro";
import AlbumDetailEditor from "@components/album/AlbumDetailEditor.svelte";
import { buildDirectusAssetUrl } from "@/server/directus-auth";
import {
  loadProfileForViewer,
  loadUserAlbumDetail,
  profileToSidebarData,
} from "@/server/api/v1/public-data";
import type { ContentLoadResult } from "@/server/api/v1/public-data";
import { getSessionUser } from "@/server/auth/session";

export const prerender = false;

const username = (Astro.params.username || "").trim();
const id = (Astro.params.id || "").trim();

type AlbumPageData = {
  id: string;
  short_id: string | null;
  title: string;
  slug: string;
  description: string | null;
  cover_file: string | null;
  cover_url: string | null;
  date: string | null;
  location: string | null;
  tags: string[];
  category: string | null;
  layout: "grid" | "masonry";
  columns: number;
  status: "draft" | "published";
  is_public: boolean;
  show_on_profile: boolean;
  author_id: string;
  author?: { name?: string; username?: string };
  photos: Array<{
    id: string;
    file_id: string | null;
    image_url: string | null;
    title: string | null;
    description: string | null;
    tags: string[];
    location: string | null;
    sort: number | null;
  }>;
};

let result: ContentLoadResult<AlbumPageData> = { status: "not_found" };
let isOwner = false;
let autoEdit = false;

if (!username || !id) {
  Astro.response.status = 404;
} else {
  try {
    const sessionUser = await getSessionUser(Astro);
    const viewerId = sessionUser?.id ?? null;
    result = (await loadUserAlbumDetail(username, id, {
      viewerId,
    })) as ContentLoadResult<AlbumPageData>;
    if (result.status === "not_found") {
      Astro.response.status = 404;
    } else if (result.status === "permission_denied") {
      Astro.response.status = 403;
    } else {
      const profile = await loadProfileForViewer(username, viewerId);
      if (profile) {
        Astro.locals.sidebarProfile = profileToSidebarData(profile);
        isOwner = Boolean(viewerId) && viewerId === profile.user_id;
      }
      autoEdit = isOwner && Astro.url.searchParams.get("edit") === "1";
    }
  } catch (error) {
    console.error("[albums] failed to load detail:", error);
    Astro.response.status = 500;
  }
}

const album = result.status === "ok" ? result.data : null;

function photoUrl(
  photo: {
    file_id: string | null;
    image_url: string | null;
  },
  layout: "grid" | "masonry",
): string | null {
  if (photo.image_url) {
    return photo.image_url;
  }
  if (photo.file_id) {
    if (layout === "masonry") {
      return buildDirectusAssetUrl(photo.file_id, {
        width: 1920,
      });
    }
    return buildDirectusAssetUrl(photo.file_id, {
      width: 1200,
      height: 900,
      fit: "cover",
    });
  }
  return null;
}

function photoPreviewUrl(photo: {
  file_id: string | null;
  image_url: string | null;
}): string | null {
  if (photo.image_url) {
    return photo.image_url;
  }
  if (photo.file_id) {
    return buildDirectusAssetUrl(photo.file_id, {
      width: 1920,
    });
  }
  return null;
}

function buildGoogleMapsSearchUrl(value: string | null | undefined): string {
  const query = String(value || "").trim();
  return `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
}

function formatAlbumDate(value: string | null | undefined): string {
  const raw = String(value || "").trim();
  if (!raw) {
    return "";
  }
  const parsed = new Date(raw);
  if (Number.isNaN(parsed.getTime())) {
    return raw;
  }
  return `${parsed.getFullYear()}/${String(parsed.getMonth() + 1).padStart(2, "0")}/${String(parsed.getDate()).padStart(2, "0")}`;
}
---

<MainGridLayout
  title={album?.title || "相册不存在"}
  description={album?.description || ""}
>
  {
    result.status === "permission_denied" ? (
      <ContentNotVisible
        mode="permission_denied"
        title="相册不可见"
        description="由于用户权限设置，该用户的相册内容不可见。"
        backHref={`/${username}/albums`}
        backLabel="返回相册列表"
      />
    ) : !album ? (
      <ContentNotVisible
        mode="not_found"
        title="相册不存在"
        description="该相册可能未公开或已删除。"
        backHref={`/${username}/albums`}
        backLabel="返回相册列表"
      />
    ) : isOwner ? (
      <AlbumDetailEditor
        client:only="svelte"
        albumId={album.id}
        albumShortId={album.short_id}
        username={username}
        isOwner={true}
        initialEditMode={autoEdit}
        album={{
          title: album.title,
          description: album.description,
          category: album.category,
          tags: album.tags,
          date: album.date,
          location: album.location,
          layout: album.layout,
          columns: album.columns,
          status: album.status,
          is_public: album.is_public,
          show_on_profile: album.show_on_profile,
          cover_file: album.cover_file,
          cover_url: album.cover_url,
        }}
        photos={album.photos.map((p) => ({
          id: p.id,
          file_id: p.file_id,
          image_url: p.image_url,
          title: p.title,
          description: p.description,
          tags: p.tags,
          location: p.location,
          sort: p.sort,
        }))}
      />
    ) : (
      <>
        <section class="card-base p-6 rounded-(--radius-large) mb-4 space-y-3 text-90">
          <a
            href={`/${username}/albums`}
            data-no-swup
            class="text-sm text-(--primary) hover:underline"
          >
            返回相册列表
          </a>
          <h1 class="text-3xl font-bold">{album.title}</h1>
          <div class="text-xs text-60 flex flex-wrap items-center gap-2">
            {album.author?.name && <span>{album.author.name}</span>}
            {album.date && <span>{formatAlbumDate(album.date)}</span>}
            {album.location && (
              <a
                href={buildGoogleMapsSearchUrl(album.location)}
                target="_blank"
                rel="noopener noreferrer"
                class="inline-flex items-center gap-1 px-1.5 py-0.5 rounded transition-colors hover:bg-(--btn-plain-bg-hover) active:bg-(--btn-plain-bg-active) hover:text-(--primary)"
                data-no-swup
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="w-3.5 h-3.5"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  aria-hidden="true"
                >
                  <path d="M12 22s8-6.2 8-12a8 8 0 10-16 0c0 5.8 8 12 8 12z" />
                  <circle cx="12" cy="10" r="3" />
                </svg>
                {album.location}
              </a>
            )}
            {album.category && (
              <span class="px-2 py-0.5 rounded bg-(--btn-plain-bg-hover) text-75">
                {album.category}
              </span>
            )}
          </div>
          {album.description && <p class="text-75">{album.description}</p>}
          {album.tags.length > 0 && (
            <div class="flex flex-wrap gap-2">
              {album.tags.map((tag) => (
                <span class="btn-regular h-7 text-xs px-3 rounded-lg">
                  #{tag}
                </span>
              ))}
            </div>
          )}
        </section>

        {album.photos.length === 0 ? (
          <div class="card-base p-8 rounded-(--radius-large) text-70">
            该相册暂无可展示照片。
          </div>
        ) : (
          <div
            class:list={[
              "mzk-album-gallery gap-3",
              album.layout === "masonry"
                ? "columns-2 md:columns-3"
                : "grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4",
            ]}
          >
            {album.photos.map((photo) => {
              const thumbSrc = photoUrl(photo, album.layout);
              const previewSrc = photoPreviewUrl(photo) || thumbSrc;
              const captionText = [photo.title, photo.description]
                .filter(Boolean)
                .join("\n");

              return (
                <figure
                  class:list={[
                    "album-photo-item rounded-xl overflow-hidden border border-(--line-divider) bg-(--card-bg) relative",
                    album.layout === "masonry" ? "mb-3 break-inside-avoid" : "",
                  ]}
                >
                  {thumbSrc && previewSrc && (
                    <a
                      href={previewSrc}
                      data-fancybox="album-photo-preview"
                      data-caption={captionText || undefined}
                      data-no-swup
                      class="block relative"
                    >
                      <img
                        src={thumbSrc}
                        alt={photo.title || "album photo"}
                        class="w-full h-auto object-cover"
                        loading="lazy"
                      />
                      {(photo.title || photo.description) &&
                        album.layout === "grid" && (
                          <div class="absolute inset-x-0 bottom-0 p-3 space-y-1 text-white bg-linear-to-t from-black/70 via-black/35 to-transparent">
                            {photo.title && (
                              <div class="text-sm font-medium line-clamp-1">
                                {photo.title}
                              </div>
                            )}
                            {photo.description && (
                              <div class="text-xs text-white/85 line-clamp-2">
                                {photo.description}
                              </div>
                            )}
                          </div>
                        )}
                    </a>
                  )}
                  {(photo.title || photo.description) &&
                    album.layout !== "grid" && (
                      <figcaption class="p-3 space-y-1 text-90">
                        {photo.title && (
                          <div class="text-sm font-medium">{photo.title}</div>
                        )}
                        {photo.description && (
                          <div class="text-xs text-60">{photo.description}</div>
                        )}
                      </figcaption>
                    )}
                </figure>
              );
            })}
          </div>
        )}
      </>
    )
  }
</MainGridLayout>
