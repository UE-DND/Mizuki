---
import Comment from "@components/comment/index.astro";
import ContentNotVisible from "@components/misc/ContentNotVisible.astro";
import Markdown from "@components/misc/Markdown.astro";
import MainGridLayout from "@layouts/MainGridLayout.astro";
import { renderMarkdown } from "@/server/markdown/render";
import { buildDirectusAssetUrl } from "@/server/directus-auth";
import {
	isSpecialArticleSlug,
	loadArticleByShortIdLoose,
	loadArticleBySlugLoose,
	loadPublicArticleByShortId,
	loadPublicArticleBySlug,
	safeCsv,
} from "@/server/api/v1/shared";
import { isShortId } from "@/server/utils/short-id";
import { getAuthorBundle } from "@/server/api/v1/shared/author-cache";
import { readAuthor } from "@/server/api/v1/public-data";
import {
	loadProfileForViewerByUserId,
	profileToSidebarData,
} from "@/server/api/v1/public-data";
import { getSessionUser } from "@/server/auth/session";
import ArticleManageFloat from "@components/control/ArticleManageFloat.astro";

export const prerender = false;

const rawId = (Astro.params.id || "").replace(/^\/+|\/+$/g, "");

let article: {
	id: string;
	title: string;
	slug: string | null;
	summary: string | null;
	body_markdown: string;
	cover_file: string | null;
	cover_url: string | null;
	tags: string[];
	category: string | null;
	allow_comments: boolean;
	published_at: string | null;
	author?: { id?: string; name?: string };
} | null = null;
let articleHtml = "";

if (rawId) {
	try {
		const sessionUser = await getSessionUser(Astro);

		// First try public query
		let rawArticle = isShortId(rawId)
			? await loadPublicArticleByShortId(rawId)
			: isSpecialArticleSlug(rawId)
				? await loadPublicArticleBySlug(rawId)
				: null;

		// Public query failed + user is logged in → try owner fallback
		if (!rawArticle && sessionUser) {
			const candidate = isShortId(rawId)
				? await loadArticleByShortIdLoose(rawId)
				: isSpecialArticleSlug(rawId)
					? await loadArticleBySlugLoose(rawId)
					: null;
			if (candidate && candidate.author_id === sessionUser.id) {
				rawArticle = candidate;
			}
		}

		if (rawArticle) {
			const authorMap = await getAuthorBundle([rawArticle.author_id]);
			article = {
				...rawArticle,
				tags: safeCsv(rawArticle.tags),
				author: readAuthor(authorMap, rawArticle.author_id),
			};
			articleHtml = await renderMarkdown(
				String(rawArticle.body_markdown || ""),
				{
					target: "page",
				},
			);
			const authorProfile = await loadProfileForViewerByUserId(
				rawArticle.author_id,
				sessionUser?.id ?? null,
			);
			if (authorProfile) {
				Astro.locals.sidebarProfile = profileToSidebarData(authorProfile);
			}
		} else {
			Astro.response.status = 404;
		}
	} catch (error) {
		console.error("[posts] failed to load article:", error);
		Astro.response.status = 500;
	}
} else {
	Astro.response.status = 404;
}

const coverUrl = article?.cover_url
	? article.cover_url
	: article?.cover_file
		? buildDirectusAssetUrl(article.cover_file, {
				width: 1600,
				height: 900,
				fit: "cover",
		  })
		: null;
---

<MainGridLayout
	setOGTypeArticle={true}
	title={article?.title || "文章未找到"}
	description={article?.summary || ""}
>
	{!article ? (
		<ContentNotVisible
			mode="not_found"
			title="文章不存在"
			description="该文章可能未发布、已删除，或链接错误。"
			backHref="/"
			backLabel="返回首页"
		/>
	) : (
		<>
			<article
				id="post-container"
				data-enter-skeleton-target="post-detail"
				class="card-base p-6 md:p-8 rounded-[var(--radius-large)] mb-4 relative"
			>
				<div data-enter-skeleton-content>
					<header class="mb-6 space-y-3">
						<h1 class="text-3xl md:text-4xl font-bold text-90">{article.title}</h1>
						<div class="flex flex-wrap items-center gap-3 text-sm text-60">
							{article.author?.name && <span>作者：{article.author.name}</span>}
							{article.published_at && <time datetime={article.published_at}>发布时间：{new Date(article.published_at).toLocaleString()}</time>}
							{article.category && <span>分类：{article.category}</span>}
						</div>
						{article.summary && <p class="text-base text-75">{article.summary}</p>}
						{article.tags.length > 0 && (
							<div class="flex flex-wrap gap-2">
								{article.tags.map((tag) => (
									<span class="btn-regular h-7 text-xs px-3 rounded-lg">#{tag}</span>
								))}
							</div>
						)}
					</header>

					{coverUrl && (
						<div class="mb-6">
							<img src={coverUrl} alt={article.title} class="w-full max-h-[420px] object-cover rounded-xl border border-[var(--line-divider)]" loading="lazy" />
						</div>
					)}

					<Markdown class="markdown-content">
						<Fragment set:html={articleHtml} />
					</Markdown>
				</div>
				<div data-enter-skeleton-placeholder aria-hidden="true" class="absolute inset-0 z-20 pointer-events-none p-6 md:p-8">
					<div class="space-y-4">
						<div class="md3-skeleton-text" style="--skeleton-width: 62%; --skeleton-height: 2rem;"></div>
						<div class="md3-skeleton-text" style="--skeleton-width: 48%; --skeleton-height: 0.95rem;"></div>
						<div class="space-y-2 pt-1">
							<div class="md3-skeleton-text" style="--skeleton-width: 92%;"></div>
							<div class="md3-skeleton-text" style="--skeleton-width: 66%;"></div>
						</div>
						{coverUrl && (
							<div class="md3-skeleton-block h-[240px] md:h-[320px] w-full rounded-xl"></div>
						)}
						<div class="space-y-3 pt-2">
							<div class="md3-skeleton-text" style="--skeleton-width: 100%;"></div>
							<div class="md3-skeleton-text" style="--skeleton-width: 96%;"></div>
							<div class="md3-skeleton-text" style="--skeleton-width: 94%;"></div>
							<div class="md3-skeleton-text" style="--skeleton-width: 98%;"></div>
							<div class="md3-skeleton-text" style="--skeleton-width: 90%;"></div>
							<div class="md3-skeleton-text" style="--skeleton-width: 84%;"></div>
							<div class="md3-skeleton-text" style="--skeleton-width: 88%;"></div>
							<div class="md3-skeleton-text" style="--skeleton-width: 72%;"></div>
						</div>
					</div>
				</div>
			</article>

			<ArticleManageFloat articleId={article.id} authorId={article.author?.id || ""} />

			<Comment module="articles" contentId={article.id} allowComments={article.allow_comments} />
		</>
	)}
</MainGridLayout>
