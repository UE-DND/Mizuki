---
import Comment from "@components/comment/index.astro";
import Markdown from "@components/misc/Markdown.astro";
import MainGridLayout from "@layouts/MainGridLayout.astro";
import { renderMarkdownHtml } from "@/server/markdown/render";
import { buildDirectusAssetUrl } from "@/server/directus-auth";

export const prerender = false;

const slug = (Astro.params.slug || "").replace(/^\/+|\/+$/g, "");

const endpoint = `${Astro.url.origin}/api/v1/public/articles/${encodeURIComponent(slug)}/`;
let article: {
	id: string;
	title: string;
	slug: string;
	summary: string | null;
	body_markdown: string;
	cover_file: string | null;
	cover_url: string | null;
	tags: string[];
	category: string | null;
	allow_comments: boolean;
	published_at: string | null;
	author?: { id?: string; name?: string };
} | null = null;
let articleHtml = "";

if (slug) {
	try {
		const response = await fetch(endpoint, {
			headers: { Accept: "application/json" },
		});
		const data = await response.json().catch(() => null);
		if (response.ok && data?.ok && data.item) {
			const resolved = data.item;
			article = resolved;
			articleHtml = await renderMarkdownHtml(
				String(resolved.body_markdown || ""),
			);
		} else {
			Astro.response.status = 404;
		}
	} catch (error) {
		console.error("[posts] failed to fetch article:", error);
		Astro.response.status = 500;
	}
} else {
	Astro.response.status = 404;
}

const coverUrl = article?.cover_url
	? article.cover_url
	: article?.cover_file
		? buildDirectusAssetUrl(article.cover_file, {
				width: 1600,
				height: 900,
				fit: "cover",
		  })
		: null;
---

<MainGridLayout title={article?.title || "文章未找到"} description={article?.summary || ""}>
	{!article ? (
		<div class="card-base p-8 rounded-[var(--radius-large)]">
			<h1 class="text-2xl font-bold mb-2">文章不存在</h1>
			<p class="text-70">该文章可能未发布、已删除，或链接错误。</p>
		</div>
	) : (
		<>
			<article class="card-base p-6 md:p-8 rounded-[var(--radius-large)] mb-4">
				<div
					id="article-manage-root"
					class="hidden mb-4 flex items-center justify-end"
					data-article-id={article.id}
					data-author-id={article.author?.id || ""}
				>
					<details class="relative">
						<summary class="list-none cursor-pointer btn-plain scale-animation w-9 h-9 rounded-lg flex items-center justify-center text-lg select-none">
							...
						</summary>
						<div class="absolute right-0 top-10 z-10 min-w-[8rem] card-base rounded-xl border border-[var(--line-divider)] p-2">
							<button
								type="button"
								id="article-delete-trigger"
								class="w-full text-left px-3 py-2 rounded-lg text-sm text-red-500 hover:bg-black/5 dark:hover:bg-white/10"
							>
								删除文章
							</button>
						</div>
					</details>
				</div>
				<header class="mb-6 space-y-3">
					<h1 class="text-3xl md:text-4xl font-bold text-90">{article.title}</h1>
					<div class="flex flex-wrap items-center gap-3 text-sm text-60">
						{article.author?.name && <span>作者：{article.author.name}</span>}
						{article.published_at && <time datetime={article.published_at}>发布时间：{new Date(article.published_at).toLocaleString()}</time>}
						{article.category && <span>分类：{article.category}</span>}
					</div>
					{article.summary && <p class="text-base text-75">{article.summary}</p>}
					{article.tags.length > 0 && (
						<div class="flex flex-wrap gap-2">
							{article.tags.map((tag) => (
								<span class="btn-regular h-7 text-xs px-3 rounded-lg">#{tag}</span>
							))}
						</div>
					)}
				</header>

				{coverUrl && (
					<div class="mb-6">
						<img src={coverUrl} alt={article.title} class="w-full max-h-[420px] object-cover rounded-xl border border-[var(--line-divider)]" loading="lazy" />
					</div>
				)}

				<Markdown class="markdown-content">
					<Fragment set:html={articleHtml} />
				</Markdown>
			</article>

			<Comment module="articles" contentId={article.id} allowComments={article.allow_comments} />
		</>
	)}
</MainGridLayout>

<script is:inline>
	const manageRoot = document.getElementById("article-manage-root");

	if (manageRoot instanceof HTMLElement && !manageRoot.dataset.bound) {
		manageRoot.dataset.bound = "1";
		const articleId = String(manageRoot.dataset.articleId || "");
		const authorId = String(manageRoot.dataset.authorId || "");
		const deleteBtn = document.getElementById("article-delete-trigger");
		const AUTH_STATE_CACHE_KEY = "__mizukiAuthState";

		const readCachedAuthState = () => {
			const raw = window[AUTH_STATE_CACHE_KEY];
			return {
				isLoggedIn: Boolean(raw?.isLoggedIn),
				isAdmin: Boolean(raw?.isAdmin),
				userId: raw?.userId ? String(raw.userId) : "",
			};
		};

		const applyManageMenuVisibility = (state) => {
			const canDelete =
				state.isLoggedIn &&
				Boolean(state.userId) &&
				(state.isAdmin || state.userId === authorId);
			manageRoot.classList.toggle("hidden", !canDelete);
		};

		if (deleteBtn instanceof HTMLButtonElement) {
			deleteBtn.addEventListener("click", async () => {
				if (!articleId) return;
				const confirmed = window.confirm("确认删除这篇文章？删除后不可恢复。");
				if (!confirmed) return;

				deleteBtn.disabled = true;
				try {
					const response = await fetch(
						`/api/v1/me/articles/${encodeURIComponent(articleId)}/`,
						{
							method: "DELETE",
							credentials: "include",
							headers: { Accept: "application/json" },
						},
					);
					const data = await response.json().catch(() => null);
					if (!response.ok || !data?.ok) {
						window.alert(data?.message || "删除失败");
						return;
					}
					window.location.href = "/";
				} catch (error) {
					console.error("[posts] delete article failed:", error);
					window.alert("删除失败，请稍后重试");
				} finally {
					deleteBtn.disabled = false;
				}
			});
		}

		applyManageMenuVisibility(readCachedAuthState());
		document.addEventListener("mizuki:auth-state", (event) => {
			if (!(event instanceof CustomEvent)) {
				return;
			}
			const detail = event.detail || {};
			applyManageMenuVisibility({
				isLoggedIn: Boolean(detail?.isLoggedIn),
				isAdmin: Boolean(detail?.isAdmin),
				userId: detail?.userId ? String(detail.userId) : "",
			});
		});
	}
</script>
