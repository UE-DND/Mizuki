---
import MainGridLayout from "@layouts/MainGridLayout.astro";
import {
	loadUserHomeData,
	profileToSidebarData,
} from "@/server/api/v1/public-data";

export const prerender = false;

const username = (Astro.params.username || "").trim();

let payload: Awaited<ReturnType<typeof loadUserHomeData>> = null;

try {
	if (!username) {
		Astro.response.status = 404;
	} else {
		payload = await loadUserHomeData(username);
		if (!payload) {
			Astro.response.status = 404;
		} else {
			Astro.locals.sidebarProfile = profileToSidebarData(payload.profile);
		}
	}
} catch (error) {
	console.error("[profile] failed to load user home:", error);
	Astro.response.status = 500;
}

function shortDiary(text: string): string {
	const value = String(text || "").replace(/\s+/g, " ").trim();
	if (value.length <= 90) {
		return value;
	}
	return `${value.slice(0, 90)}...`;
}
---

<MainGridLayout title={payload?.owner?.name || "用户主页"} description={payload?.profile?.bio || ""}>
	{!payload ? (
		<div class="card-base p-8 rounded-[var(--radius-large)]">
			<h1 class="text-2xl font-bold mb-2">用户主页不存在</h1>
			<p class="text-70">该用户可能关闭了主页公开，或用户名不存在。</p>
		</div>
	) : (
		<>
			<section class="card-base p-6 rounded-[var(--radius-large)] mb-4">
				<div class="flex items-center gap-4">
					{payload.owner?.avatar_url ? (
						<img src={payload.owner.avatar_url} alt="avatar" class="w-16 h-16 rounded-full object-cover border border-[var(--line-divider)]" loading="lazy" />
					) : (
						<div class="w-16 h-16 rounded-full bg-black/10 dark:bg-white/10" />
					)}
					<div>
						<h1 class="text-2xl font-bold">{payload.owner?.name || "用户"}</h1>
						<p class="text-xs text-60">@{payload.owner?.username || username}</p>
					</div>
				</div>
				{payload.profile?.bio && <p class="mt-4 text-sm text-75 leading-7">{payload.profile.bio}</p>}
			</section>

			{Array.isArray(payload.articles) && payload.articles.length > 0 && (
				<section class="card-base p-6 rounded-[var(--radius-large)] mb-4 space-y-3">
					<h2 class="text-xl font-semibold">文章</h2>
					<ul class="space-y-2">
						{payload.articles.map((item) => (
							<li>
								<a href={`/posts/${item.id}/`} class="hover:text-[var(--primary)] transition-colors">{item.title}</a>
							</li>
						))}
					</ul>
				</section>
			)}

			{Array.isArray(payload.diaries) && payload.diaries.length > 0 && (
				<section class="card-base p-6 rounded-[var(--radius-large)] mb-4 space-y-3">
					<h2 class="text-xl font-semibold">日记</h2>
					<ul class="space-y-2 text-sm text-75">
						{payload.diaries.map((item) => (
							<li>
								<a href={`/${payload.owner?.username || username}/diary/${item.id}/`} class="hover:text-[var(--primary)] transition-colors">
									{shortDiary(item.content)}
								</a>
							</li>
						))}
					</ul>
				</section>
			)}

			{Array.isArray(payload.anime) && payload.anime.length > 0 && (
				<section class="card-base p-6 rounded-[var(--radius-large)] mb-4 space-y-3">
					<h2 class="text-xl font-semibold">番剧</h2>
					<ul class="space-y-2 text-sm text-75">
						{payload.anime.map((item) => (
							<li>{item.title} · {item.watch_status}</li>
						))}
					</ul>
				</section>
			)}

			{Array.isArray(payload.albums) && payload.albums.length > 0 && (
				<section class="card-base p-6 rounded-[var(--radius-large)] mb-4 space-y-3">
					<h2 class="text-xl font-semibold">相册</h2>
					<ul class="space-y-2">
						{payload.albums.map((item) => (
							<li>
								<a href={`/${payload.owner?.username || username}/albums/${item.id}/`} class="hover:text-[var(--primary)] transition-colors">{item.title}</a>
							</li>
						))}
					</ul>
				</section>
			)}

			{payload.comments && (
				<section class="card-base p-6 rounded-[var(--radius-large)] space-y-3">
					<h2 class="text-xl font-semibold">评论</h2>
					<div class="text-sm text-70">
						文章评论：{payload.comments.article_comments?.length || 0} 条
					</div>
					<div class="text-sm text-70">
						日记评论：{payload.comments.diary_comments?.length || 0} 条
					</div>
				</section>
			)}
		</>
	)}
</MainGridLayout>
