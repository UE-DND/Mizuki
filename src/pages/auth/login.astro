---
import MainGridLayout from "@layouts/MainGridLayout.astro";
import { Icon } from "astro-icon/components";
import { getResolvedSiteSettings } from "@/server/site-settings/service";

export const prerender = false;

const resolvedSettings =
  Astro.locals.siteSettings ?? (await getResolvedSiteSettings());
const registerEnabled = Boolean(
  resolvedSettings.settings.auth?.register_enabled,
);
---

<MainGridLayout title="登录" description="前端用户登录">
  <div
    data-enter-skeleton-page="auth-login"
    data-enter-skeleton-target="auth-login"
  >
    <div data-enter-skeleton-inline-content>
      <div class="home-layout">
        <div class="min-w-0">
          <div class="card-base rounded-(--radius-large) p-6 p-8 login-card">
            <div class="flex items-center gap-3 mb-2">
              <div
                class="w-12 h-12 rounded-2xl bg-(--btn-regular-bg) flex items-center justify-center login-icon-box"
              >
                <Icon
                  name="material-symbols:login-rounded"
                  class="text-(--btn-content) text-3xl"
                />
              </div>
              <div>
                <h1 class="text-2xl font-bold text-90">登录</h1>
                <p class="text-sm text-75">账号需由管理员在后台创建或邀请。</p>
              </div>
            </div>

            <div class="mt-6">
              <form id="login-form" class="login-fields">
                <div class="login-field-group">
                  <label for="login-email" class="login-field-label text-75"
                    >邮箱</label
                  >
                  <div class="login-input-wrapper">
                    <Icon
                      name="material-symbols:mail-outline-rounded"
                      class="login-input-icon"
                    />
                    <input
                      id="login-email"
                      type="email"
                      autocomplete="email"
                      required
                      class="login-input login-email-input"
                      placeholder="name@example.com"
                    />
                  </div>
                </div>

                <div class="login-field-group">
                  <label for="login-password" class="login-field-label text-75"
                    >密码</label
                  >
                  <div class="login-input-wrapper">
                    <Icon
                      name="material-symbols:lock-outline"
                      class="login-input-icon"
                    />
                    <input
                      id="login-password"
                      type="password"
                      autocomplete="current-password"
                      required
                      class="login-input login-password-input is-masked"
                      placeholder="在此输入密码喵～"
                    />
                    <button
                      id="login-password-toggle"
                      type="button"
                      class="login-password-toggle"
                      aria-label="显示密码"
                      aria-pressed="false"
                    >
                      <svg
                        class="login-password-icon login-password-icon-show"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="1.8"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        aria-hidden="true"
                      >
                        <path
                          d="M2 12s3.5-6 10-6 10 6 10 6-3.5 6-10 6-10-6-10-6z"
                        ></path>
                        <circle cx="12" cy="12" r="3"></circle>
                      </svg>
                      <svg
                        class="login-password-icon login-password-icon-hide hidden"
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="1.8"
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        aria-hidden="true"
                      >
                        <path d="M3 3l18 18"></path>
                        <path d="M10.6 10.6a2 2 0 102.8 2.8"></path>
                        <path
                          d="M9.9 5.3A11 11 0 0112 5c6.5 0 10 7 10 7a16.2 16.2 0 01-4 4.7"
                        ></path>
                        <path
                          d="M6.3 6.3A16.1 16.1 0 002 12s3.5 7 10 7c1 0 2-.2 2.9-.5"
                        ></path>
                      </svg>
                    </button>
                  </div>
                </div>

                <div id="login-error" class="login-error hidden" role="alert">
                </div>

                <div class="login-remember-row">
                  <div class="login-remember-left">
                    <input
                      id="login-remember"
                      type="checkbox"
                      checked
                      class="toggle-checkbox"
                    />
                    <label for="login-remember" class="toggle-track">
                      <span class="toggle-knob"></span>
                    </label>
                    <label
                      for="login-remember"
                      class="login-remember-label text-75"
                    >
                      保持登录状态
                    </label>
                  </div>
                  {
                    registerEnabled ? (
                      <p class="login-register-hint text-70">
                        还没有账号？
                        <a
                          class="text-(--primary) hover:underline"
                          href="/auth/register"
                        >
                          提交注册申请
                        </a>
                      </p>
                    ) : null
                  }
                </div>

                <button
                  id="login-submit"
                  type="submit"
                  class="login-submit-btn"
                >
                  <span class="login-submit-text">登录</span>
                </button>
              </form>
            </div>
          </div>
        </div>
        <div class="home-sidebar-placeholder"></div>
      </div>
    </div>
    <div data-enter-skeleton-inline-placeholder aria-hidden="true">
      <div class="home-layout">
        <div class="min-w-0">
          <div class="card-base rounded-(--radius-large) p-6 p-8 space-y-6">
            <div class="flex items-center gap-3">
              <div class="md3-skeleton-block w-12 h-12 rounded-2xl"></div>
              <div class="space-y-2 flex-1">
                <div
                  class="md3-skeleton-text"
                  style="--skeleton-width: 22%; --skeleton-height: 1.6rem;"
                >
                </div>
                <div
                  class="md3-skeleton-text"
                  style="--skeleton-width: 52%; --skeleton-height: 0.82rem;"
                >
                </div>
              </div>
            </div>
            <div class="space-y-4">
              <div class="space-y-2">
                <div
                  class="md3-skeleton-text"
                  style="--skeleton-width: 12%; --skeleton-height: 0.82rem;"
                >
                </div>
                <div class="md3-skeleton-block h-11 rounded-lg"></div>
              </div>
              <div class="space-y-2">
                <div
                  class="md3-skeleton-text"
                  style="--skeleton-width: 12%; --skeleton-height: 0.82rem;"
                >
                </div>
                <div class="md3-skeleton-block h-11 rounded-lg"></div>
              </div>
              <div class="flex items-center justify-between gap-3">
                <div class="flex items-center gap-2">
                  <div class="md3-skeleton-circle h-5 w-9 rounded-full"></div>
                  <div
                    class="md3-skeleton-text"
                    style="--skeleton-width: 6.5rem; --skeleton-height: 0.82rem;"
                  >
                  </div>
                </div>
                <div
                  class="md3-skeleton-text"
                  style="--skeleton-width: 8.2rem; --skeleton-height: 0.82rem;"
                >
                </div>
              </div>
              <div class="md3-skeleton-block h-11 rounded-xl"></div>
            </div>
          </div>
        </div>
        <div class="home-sidebar-placeholder"></div>
      </div>
    </div>
  </div>

  <script is:inline>
    const API_LOGIN = "/api/auth/login";
    function getCsrfToken() {
      const m = document.cookie.match(/(?:^|;\s*)dacapo_csrf=([^;]*)/);
      return m ? decodeURIComponent(m[1]) : "";
    }

    function normalizeRedirectTarget(redirect) {
      const candidate = String(redirect || "").trim();
      if (
        !candidate ||
        !candidate.startsWith("/") ||
        candidate.startsWith("//")
      ) {
        return "/";
      }
      if (candidate === "/auth/login" || candidate === "/login") {
        return "/";
      }
      return candidate;
    }

    function getRedirectTarget() {
      try {
        const u = new URL(window.location.href);
        return normalizeRedirectTarget(u.searchParams.get("redirect"));
      } catch {
        return "/";
      }
    }

    function setError(message) {
      const errorEl = document.getElementById("login-error");
      if (!errorEl) return;
      if (message) {
        errorEl.textContent = message;
        errorEl.classList.remove("hidden");
      } else {
        errorEl.textContent = "";
        errorEl.classList.add("hidden");
      }
    }

    async function initLoginForm() {
      const form = document.getElementById("login-form");
      const emailEl = document.getElementById("login-email");
      const pwdEl = document.getElementById("login-password");
      const rememberEl = document.getElementById("login-remember");
      const submitBtn = document.getElementById("login-submit");
      const passwordToggleEl = document.getElementById("login-password-toggle");

      if (
        !form ||
        !emailEl ||
        !pwdEl ||
        !rememberEl ||
        !submitBtn ||
        !passwordToggleEl
      ) {
        return;
      }

      if (form.dataset.bound) {
        return;
      }
      form.dataset.bound = "1";

      passwordToggleEl.addEventListener("click", () => {
        const isPassword = pwdEl.type === "password";
        pwdEl.type = isPassword ? "text" : "password";
        pwdEl.classList.toggle("is-masked", !isPassword);
        passwordToggleEl
          .querySelector(".login-password-icon-show")
          ?.classList.toggle("hidden", isPassword);
        passwordToggleEl
          .querySelector(".login-password-icon-hide")
          ?.classList.toggle("hidden", !isPassword);
        passwordToggleEl.setAttribute(
          "aria-label",
          isPassword ? "隐藏密码" : "显示密码",
        );
        passwordToggleEl.setAttribute(
          "aria-pressed",
          isPassword ? "true" : "false",
        );
      });

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        setError("");

        const email = String(emailEl.value || "").trim();
        const password = String(pwdEl.value || "");
        if (!email || !password) {
          setError("请填写邮箱与密码！(＃｀д´)ﾉ");
          return;
        }

        submitBtn.disabled = true;
        submitBtn.classList.add("is-loading");
        const textEl = submitBtn.querySelector(".login-submit-text");
        if (textEl) textEl.textContent = "正在登录喵…";

        try {
          const resp = await fetch(API_LOGIN, {
            method: "POST",
            credentials: "include",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
              "x-csrf-token": getCsrfToken(),
            },
            body: JSON.stringify({
              email,
              password,
              remember: rememberEl.checked,
            }),
          });

          const data = await resp.json().catch(() => null);
          if (!resp.ok || !data?.ok) {
            setError(data?.error?.message || "登录失败");
            return;
          }

          window.location.href = getRedirectTarget();
        } catch (err) {
          console.error("Login failed:", err);
          setError("登录失败，请稍后再试");
        } finally {
          submitBtn.disabled = false;
          submitBtn.classList.remove("is-loading");
          if (textEl) textEl.textContent = "登录";
        }
      });
    }

    initLoginForm();
    document.addEventListener("astro:after-swap", initLoginForm);
  </script>

  <style>
    .home-layout {
      display: grid;
      grid-template-columns: 1fr 17.5rem;
      gap: 1rem;
      align-items: start;
    }
    .home-sidebar-placeholder {
      /* 纯占位，不渲染任何内容 */
    }

    .login-card {
      animation: loginCardIn 0.5s cubic-bezier(0.22, 1, 0.36, 1) both;
    }
    @keyframes loginCardIn {
      from {
        opacity: 0;
        transform: translateY(12px) scale(0.98);
      }
    }
    .login-fields {
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }
    .login-field-group {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
    }
    .login-field-label {
      font-size: 0.8125rem;
      font-weight: 500;
      padding-left: 0.125rem;
    }

    .login-input-wrapper {
      position: relative;
      display: flex;
      align-items: center;
    }
    .login-input-icon {
      position: absolute;
      left: 0.875rem;
      width: 1.25rem;
      height: 1.25rem;
      color: var(--primary);
      opacity: 0.55;
      transition: opacity 0.2s;
      pointer-events: none;
    }
    .login-input-wrapper:focus-within .login-input-icon {
      opacity: 1;
    }
    .login-input {
      width: 100%;
      padding: 0.75rem 4.25rem 0.75rem 2.75rem;
      border-radius: 0.75rem;
      border: 1.5px solid var(--line-divider);
      background: transparent;
      color: rgb(24 24 27);
      font-size: 1rem;
      outline: none;
      transition:
        border-color 0.2s,
        box-shadow 0.2s;
    }
    :root.dark .login-input {
      color: rgb(244 244 245);
    }
    .login-input::placeholder {
      font-size: 0.9375rem;
      opacity: 0.9;
      color: rgb(113 113 122 / 0.9);
    }
    :root.dark .login-input::placeholder {
      color: rgb(212 212 216 / 0.82);
    }
    .login-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px oklch(from var(--primary) l c h / 0.1);
    }
    .login-email-input {
      font-size: 1.0625rem;
    }
    .login-password-input {
      font-size: 1.0625rem;
      letter-spacing: 0.12em;
    }
    .login-password-input.is-masked {
      -webkit-text-security: disc;
      text-security: disc;
    }
    .login-password-input::placeholder {
      letter-spacing: normal;
    }
    .login-password-toggle {
      position: absolute;
      right: 0.625rem;
      top: 50%;
      transform: translateY(-50%);
      border: 1px solid var(--line-divider);
      background: rgb(255 255 255 / 0.7);
      color: rgb(39 39 42);
      width: 2rem;
      height: 2rem;
      line-height: 1;
      border-radius: 0.5rem;
      cursor: pointer;
      z-index: 1;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition:
        border-color 0.2s,
        background-color 0.2s,
        color 0.2s;
    }
    :root.dark .login-password-toggle {
      background: rgb(39 39 42 / 0.72);
      color: rgb(228 228 231);
    }
    .login-password-toggle:hover {
      border-color: var(--primary);
      background: oklch(from var(--primary) l c h / 0.1);
    }
    .login-password-icon {
      width: 1rem;
      height: 1rem;
    }

    .login-remember-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    .login-remember-left {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    .login-remember-label {
      font-size: 0.8125rem;
      cursor: pointer;
      user-select: none;
      line-height: 1;
    }
    .login-register-hint {
      margin: 0;
      font-size: 0.8125rem;
      text-align: right;
      white-space: nowrap;
    }

    .login-error {
      font-size: 0.8125rem;
      color: oklch(0.55 0.2 25);
      background: oklch(0.55 0.2 25 / 0.08);
      border-radius: 0.625rem;
      padding: 0.625rem 0.875rem;
      animation: loginShake 0.35s ease;
    }
    :root.dark .login-error {
      color: oklch(0.75 0.18 25);
      background: oklch(0.75 0.18 25 / 0.1);
    }
    @keyframes loginShake {
      15%,
      45%,
      75% {
        transform: translateX(-3px);
      }
      30%,
      60% {
        transform: translateX(3px);
      }
    }

    .login-submit-btn {
      position: relative;
      width: 100%;
      padding: 0.8125rem 1rem;
      border-radius: 0.75rem;
      border: none;
      background: var(--btn-regular-bg);
      color: var(--btn-content);
      font-size: 0.9375rem;
      font-weight: 600;
      letter-spacing: 0.02em;
      cursor: pointer;
      overflow: hidden;
      transition:
        background-color 0.15s,
        transform 0.15s cubic-bezier(0.22, 1, 0.36, 1);
    }
    .login-submit-btn:hover:not(:disabled) {
      background: var(--btn-regular-bg-hover);
    }
    .login-submit-btn:active:not(:disabled) {
      background: var(--btn-regular-bg-active);
      transform: scale(0.98);
    }
    .login-submit-btn:disabled {
      cursor: not-allowed;
      opacity: 0.7;
    }
    .login-submit-btn.is-loading .login-submit-text {
      animation: loginPulseText 1.2s ease-in-out infinite;
    }
    @keyframes loginPulseText {
      0%,
      100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }
  </style>
</MainGridLayout>
