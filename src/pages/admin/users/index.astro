---
import AdminLayout from "@layouts/AdminLayout.astro";

export const prerender = false;
---

<AdminLayout title="用户管理" description="管理员管理用户账号与权限">
  <div class="space-y-4 text-75">
    <section
      class="card-base px-9 py-6 rounded-[var(--radius-large)] space-y-2"
    >
      <h1
        class="text-4xl font-bold text-90 mb-2 relative
				before:w-1 before:h-8 before:rounded-md before:bg-[var(--primary)]
				before:absolute before:top-1/2 before:-translate-y-1/2 before:-left-4"
      >
        用户管理
      </h1>
      <p class="text-base text-70">
        管理员可创建用户、设置应用角色与功能开关。
      </p>
    </section>

    <section class="card-base p-6 rounded-[var(--radius-large)] space-y-3">
      <h2 class="text-xl font-semibold text-90">新建用户</h2>
      <form
        id="admin-user-create"
        class="grid grid-cols-1 md:grid-cols-2 gap-3"
      >
        <input
          id="create-email"
          type="email"
          placeholder="邮箱"
          class="rounded-lg border border-[var(--line-divider)] px-3 py-2 bg-black/5 dark:bg-white/5 text-75 placeholder:text-50"
          required
        />
        <input
          id="create-password"
          type="password"
          placeholder="初始密码"
          class="rounded-lg border border-[var(--line-divider)] px-3 py-2 bg-black/5 dark:bg-white/5 text-75 placeholder:text-50"
          required
        />
        <input
          id="create-first-name"
          placeholder="名"
          class="rounded-lg border border-[var(--line-divider)] px-3 py-2 bg-black/5 dark:bg-white/5 text-75 placeholder:text-50"
        />
        <input
          id="create-last-name"
          placeholder="姓"
          class="rounded-lg border border-[var(--line-divider)] px-3 py-2 bg-black/5 dark:bg-white/5 text-75 placeholder:text-50"
        />
        <input
          id="create-username"
          placeholder="用户名（可选）"
          class="rounded-lg border border-[var(--line-divider)] px-3 py-2 bg-black/5 dark:bg-white/5 text-75 placeholder:text-50"
        />
        <select
          id="create-app-role"
          class="rounded-lg border border-[var(--line-divider)] px-3 py-2 bg-black/5 dark:bg-white/5 text-75"
        >
          <option value="member">member</option>
          <option value="admin">admin</option>
        </select>
        <div class="md:col-span-2">
          <button
            type="submit"
            class="px-4 py-2 rounded-lg bg-[var(--btn-regular-bg)] text-[var(--btn-content)] text-sm"
            >创建用户</button
          >
          <span id="admin-user-create-msg" class="ml-2 text-xs text-60"></span>
        </div>
      </form>
    </section>

    <section class="card-base p-6 rounded-[var(--radius-large)] space-y-3">
      <div class="flex items-center justify-between gap-3">
        <h2 class="text-xl font-semibold text-90">用户列表</h2>
        <button
          id="admin-users-refresh"
          class="px-3 py-2 rounded-lg border border-[var(--line-divider)] text-sm text-75 hover:bg-[var(--btn-plain-bg-hover)] transition-colors"
          >刷新</button
        >
      </div>
      <div class="overflow-auto">
        <table class="w-full text-sm min-w-[860px] text-75">
          <thead>
            <tr class="text-left text-60 border-b border-[var(--line-divider)]">
              <th class="py-2">邮箱</th>
              <th class="py-2">用户名</th>
              <th class="py-2">角色</th>
              <th class="py-2">状态</th>
              <th class="py-2">挂起</th>
              <th class="py-2">操作</th>
            </tr>
          </thead>
          <tbody id="admin-users-table"></tbody>
        </table>
      </div>
    </section>
  </div>
</AdminLayout>

<script is:inline>
  const normalizeApiUrl = (input) => {
    const [pathname, search = ""] = String(input || "").split("?");
    const normalizedPath = pathname.endsWith("/")
      ? pathname.slice(0, -1)
      : pathname;
    return search ? `${normalizedPath}?${search}` : normalizedPath;
  };

  const api = async (url, init = {}) => {
    const response = await fetch(normalizeApiUrl(url), {
      credentials: "include",
      headers: {
        Accept: "application/json",
        ...(init.body ? { "Content-Type": "application/json" } : {}),
        ...(init.headers || {}),
      },
      ...init,
    });
    const data = await response.json().catch(() => null);
    return { response, data };
  };

  const createMessage = document.getElementById("admin-user-create-msg");
  const tableBody = document.getElementById("admin-users-table");

  const renderRows = (rows) => {
    if (!tableBody) return;
    if (!Array.isArray(rows) || rows.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="6" class="py-4 text-60">暂无用户数据</td></tr>`;
      return;
    }
    tableBody.innerHTML = rows
      .map((entry) => {
        const user = entry.user || {};
        const profile = entry.profile || {};
        const permissions = entry.permissions || {};
        return `
					<tr class="border-b border-[var(--line-divider)] text-75">
						<td class="py-2 pr-2">${user.email || ""}</td>
						<td class="py-2 pr-2">${profile.username || ""}</td>
						<td class="py-2 pr-2">
							<select data-user-id="${user.id}" data-field="app_role" class="rounded border border-[var(--line-divider)] px-2 py-1 bg-black/5 dark:bg-white/5 text-75">
								<option value="member" ${permissions.app_role === "member" ? "selected" : ""}>member</option>
								<option value="admin" ${permissions.app_role === "admin" ? "selected" : ""}>admin</option>
							</select>
						</td>
						<td class="py-2 pr-2">
							<select data-user-id="${user.id}" data-field="status" class="rounded border border-[var(--line-divider)] px-2 py-1 bg-black/5 dark:bg-white/5 text-75">
								<option value="active" ${user.status === "active" ? "selected" : ""}>active</option>
								<option value="suspended" ${user.status === "suspended" ? "selected" : ""}>suspended</option>
							</select>
						</td>
						<td class="py-2 pr-2">
							<label class="inline-flex items-center gap-1 text-xs text-60">
								<input type="checkbox" data-user-id="${user.id}" data-field="is_suspended" ${permissions.is_suspended ? "checked" : ""} />
								<span>${permissions.is_suspended ? "是" : "否"}</span>
							</label>
						</td>
						<td class="py-2 pr-2">
							<div class="flex items-center gap-2">
								<button class="text-xs text-[var(--primary)] hover:underline" data-action="save" data-user-id="${user.id}">保存</button>
								<button class="text-xs text-amber-600 dark:text-amber-400 hover:underline" data-action="reset" data-user-id="${user.id}">重置密码</button>
							</div>
						</td>
					</tr>
				`;
      })
      .join("");
  };

  const loadUsers = async () => {
    const { response, data } = await api("/api/v1/admin/users?limit=200");
    if (!response.ok || !data?.ok) {
      renderRows([]);
      return;
    }
    renderRows(data.items || []);
  };

  document
    .getElementById("admin-users-refresh")
    ?.addEventListener("click", loadUsers);

  document
    .getElementById("admin-user-create")
    ?.addEventListener("submit", async (event) => {
      event.preventDefault();
      const payload = {
        email: document.getElementById("create-email").value,
        password: document.getElementById("create-password").value,
        first_name: document.getElementById("create-first-name").value,
        last_name: document.getElementById("create-last-name").value,
        username: document.getElementById("create-username").value,
        app_role: document.getElementById("create-app-role").value,
      };
      const { response, data } = await api("/api/v1/admin/users", {
        method: "POST",
        body: JSON.stringify(payload),
      });
      createMessage.textContent =
        response.ok && data?.ok ? "创建成功" : data?.message || "创建失败";
      if (response.ok && data?.ok) {
        document.getElementById("create-email").value = "";
        document.getElementById("create-password").value = "";
        document.getElementById("create-first-name").value = "";
        document.getElementById("create-last-name").value = "";
        document.getElementById("create-username").value = "";
        await loadUsers();
      }
    });

  tableBody?.addEventListener("click", async (event) => {
    const target = event.target instanceof HTMLElement ? event.target : null;
    if (!target) return;
    const action = target.getAttribute("data-action");
    const userId = target.getAttribute("data-user-id");
    if (!action || !userId) return;

    if (action === "save") {
      const row = target.closest("tr");
      if (!row) return;
      const appRole = row.querySelector(
        `select[data-user-id="${userId}"][data-field="app_role"]`,
      )?.value;
      const status = row.querySelector(
        `select[data-user-id="${userId}"][data-field="status"]`,
      )?.value;
      const isSuspended = row.querySelector(
        `input[data-user-id="${userId}"][data-field="is_suspended"]`,
      )?.checked;
      const { response, data } = await api(`/api/v1/admin/users/${userId}`, {
        method: "PATCH",
        body: JSON.stringify({
          app_role: appRole,
          status,
          is_suspended: Boolean(isSuspended),
        }),
      });
      if (!response.ok || !data?.ok) {
        window.alert(data?.message || "保存失败");
        return;
      }
      await loadUsers();
      return;
    }

    if (action === "reset") {
      const nextPassword = window.prompt("输入新密码");
      if (!nextPassword) return;
      const { response, data } = await api(
        `/api/v1/admin/users/${userId}/reset-password`,
        {
          method: "POST",
          body: JSON.stringify({ new_password: nextPassword }),
        },
      );
      if (!response.ok || !data?.ok) {
        window.alert(data?.message || "重置失败");
        return;
      }
      window.alert("密码已重置");
    }
  });

  loadUsers();
  document.addEventListener("astro:after-swap", loadUsers);
</script>
