---
import AdminLayout from "@layouts/AdminLayout.astro";

export const prerender = false;
---

<AdminLayout title="用户管理" description="管理员管理用户账号与注册审批">
  <div
    data-enter-skeleton-page="admin-users"
    data-enter-skeleton-target="admin-users"
  >
    <div data-enter-skeleton-inline-content class="space-y-4 text-75">
      <section class="card-base px-9 py-6 rounded-(--radius-large) space-y-2">
        <h1
          class="text-4xl font-bold text-90 mb-2 relative
				before:w-1 before:h-8 before:rounded-md before:bg-(--primary)
				before:absolute before:top-1/2 before:-translate-y-1/2 before:-left-4"
        >
          用户管理
        </h1>
        <p class="text-base text-70">
          管理员可审批注册申请，并维护现有用户角色与权限。
        </p>
        <div class="pt-2 flex flex-wrap items-center gap-3">
          <label
            class="flex items-center gap-3 text-75 cursor-pointer select-none"
          >
            <input
              type="checkbox"
              id="admin-register-enabled"
              class="toggle-checkbox"
            />
            <span class="toggle-track"><span class="toggle-knob"></span></span>
            开放注册入口
          </label>
          <span id="admin-register-msg" class="text-xs text-60"></span>
        </div>
      </section>

      <section class="card-base p-6 rounded-(--radius-large) space-y-3">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <h2 class="text-xl font-semibold text-90">注册申请列表</h2>
          <div class="flex items-center gap-2">
            <select
              id="admin-registration-status"
              class="rounded-lg border border-(--line-divider) px-3 py-2 text-sm bg-black/5 dark:bg-white/5 text-75"
            >
              <option value="pending">pending</option>
              <option value="approved">approved</option>
              <option value="rejected">rejected</option>
              <option value="cancelled">cancelled</option>
              <option value="all">all</option>
            </select>
            <button
              id="admin-registration-refresh"
              class="px-3 py-2 rounded-lg border border-(--line-divider) text-sm text-75 hover:bg-(--btn-plain-bg-hover) transition-colors"
            >
              刷新
            </button>
          </div>
        </div>
        <div class="overflow-auto">
          <table class="w-full text-sm min-w-[980px] text-75">
            <thead>
              <tr class="text-left text-60 border-b border-(--line-divider)">
                <th class="py-2">头像</th>
                <th class="py-2">邮箱</th>
                <th class="py-2">用户名</th>
                <th class="py-2">昵称</th>
                <th class="py-2">状态</th>
                <th class="py-2">提交时间</th>
                <th class="py-2">操作</th>
              </tr>
            </thead>
            <tbody id="admin-registration-table"></tbody>
          </table>
        </div>
        <div id="admin-registration-msg" class="text-xs text-60"></div>
      </section>

      <section class="card-base p-6 rounded-(--radius-large) space-y-3">
        <div class="flex items-center justify-between gap-3">
          <h2 class="text-xl font-semibold text-90">用户列表</h2>
          <button
            id="admin-users-refresh"
            class="px-3 py-2 rounded-lg border border-(--line-divider) text-sm text-75 hover:bg-(--btn-plain-bg-hover) transition-colors"
          >
            刷新
          </button>
        </div>
        <div class="overflow-auto">
          <table class="w-full text-sm min-w-[860px] text-75">
            <thead>
              <tr class="text-left text-60 border-b border-(--line-divider)">
                <th class="py-2">邮箱</th>
                <th class="py-2">用户名</th>
                <th class="py-2">角色</th>
                <th class="py-2">操作</th>
              </tr>
            </thead>
            <tbody id="admin-users-table"></tbody>
          </table>
        </div>
      </section>
    </div>
    <div
      data-enter-skeleton-inline-placeholder
      aria-hidden="true"
      class="space-y-4"
    >
      <section class="card-base px-9 py-6 rounded-(--radius-large) space-y-3">
        <div
          class="md3-skeleton-text"
          style="--skeleton-width: 30%; --skeleton-height: 2rem;"
        >
        </div>
        <div class="md3-skeleton-text" style="--skeleton-width: 54%;"></div>
      </section>
      <section class="card-base p-6 rounded-(--radius-large) space-y-4">
        <div class="flex items-center justify-between gap-3">
          <div
            class="md3-skeleton-text"
            style="--skeleton-width: 24%; --skeleton-height: 1.25rem;"
          >
          </div>
          <div class="md3-skeleton-block h-9 w-16 rounded-lg"></div>
        </div>
        <div class="space-y-2">
          {
            Array.from({ length: 6 }).map(() => (
              <div class="md3-skeleton-block h-11 rounded-lg" />
            ))
          }
        </div>
      </section>
      <section class="card-base p-6 rounded-(--radius-large) space-y-4">
        <div class="flex items-center justify-between gap-3">
          <div
            class="md3-skeleton-text"
            style="--skeleton-width: 20%; --skeleton-height: 1.25rem;"
          >
          </div>
          <div class="md3-skeleton-block h-9 w-16 rounded-lg"></div>
        </div>
        <div class="space-y-2">
          {
            Array.from({ length: 5 }).map(() => (
              <div class="md3-skeleton-block h-11 rounded-lg" />
            ))
          }
        </div>
      </section>
    </div>
  </div>
</AdminLayout>

<script>
  import { showConfirmDialog } from "@/scripts/dialogs";

  const normalizeApiUrl = (input: string): string => {
    const [pathname, search = ""] = String(input || "").split("?");
    const normalizedPath = pathname.endsWith("/")
      ? pathname.slice(0, -1)
      : pathname;
    return search ? `${normalizedPath}?${search}` : normalizedPath;
  };

  const api = async (url: string, init: RequestInit = {}) => {
    const response = await fetch(normalizeApiUrl(url), {
      credentials: "include",
      headers: {
        Accept: "application/json",
        ...(init.body ? { "Content-Type": "application/json" } : {}),
        ...((init.headers as Record<string, string>) || {}),
      },
      ...init,
    });
    const data = await response.json().catch(() => null);
    return { response, data };
  };

  const usersTableBody = document.getElementById(
    "admin-users-table",
  ) as HTMLTableSectionElement | null;
  const registerEnabledInput = document.getElementById(
    "admin-register-enabled",
  ) as HTMLInputElement | null;
  const registerMessage = document.getElementById("admin-register-msg");
  const registrationTableBody = document.getElementById(
    "admin-registration-table",
  ) as HTMLTableSectionElement | null;
  const registrationMessage = document.getElementById("admin-registration-msg");
  const registrationStatusSelect = document.getElementById(
    "admin-registration-status",
  ) as HTMLSelectElement | null;

  const setRegistrationMessage = (message: string) => {
    if (!registrationMessage) {
      return;
    }
    registrationMessage.textContent = String(message || "");
  };

  const setRegisterMessage = (message: string) => {
    if (!registerMessage) {
      return;
    }
    registerMessage.textContent = String(message || "");
  };

  type UnknownRecord = Record<string, unknown>;

  const resolveErrorMessage = (
    data: UnknownRecord | null,
    fallback: string,
  ) => {
    const code = String(data?.code || "");
    if (code === "REGISTER_DISABLED") {
      return "注册入口未开启";
    }
    if (code === "EMAIL_EXISTS") {
      return "邮箱已存在";
    }
    if (code === "USERNAME_EXISTS") {
      return "用户名已存在";
    }
    if (code === "REGISTRATION_REQUEST_EXISTS") {
      return "该邮箱或用户名已有待处理申请";
    }
    if (code === "REGISTRATION_STATUS_CONFLICT") {
      return "申请状态冲突，请刷新后重试";
    }
    return String(data?.message || fallback || "请求失败");
  };

  const renderUsersRows = (rows: UnknownRecord[]) => {
    if (!usersTableBody) return;
    if (!Array.isArray(rows) || rows.length === 0) {
      usersTableBody.innerHTML =
        '<tr><td colspan="4" class="py-4 text-60">暂无用户数据</td></tr>';
      return;
    }
    usersTableBody.innerHTML = rows
      .map((entry) => {
        const userRecord =
          typeof entry.user === "object" && entry.user
            ? (entry.user as UnknownRecord)
            : {};
        const profileRecord =
          typeof entry.profile === "object" && entry.profile
            ? (entry.profile as UnknownRecord)
            : {};
        const permissionsRecord =
          typeof entry.permissions === "object" && entry.permissions
            ? (entry.permissions as UnknownRecord)
            : {};

        const userId = String(userRecord.id || "");
        const userEmail = String(userRecord.email || "");
        const username = String(profileRecord.username || "");
        const appRole = String(permissionsRecord.app_role || "member");
        return `
					<tr class="border-b border-(--line-divider) text-75">
						<td class="py-2 pr-2">${userEmail}</td>
						<td class="py-2 pr-2">${username}</td>
						<td class="py-2 pr-2">
							<select data-user-id="${userId}" data-field="app_role" class="rounded border border-(--line-divider) px-2 py-1 bg-black/5 dark:bg-white/5 text-75">
								<option value="member" ${appRole === "member" ? "selected" : ""}>member</option>
								<option value="admin" ${appRole === "admin" ? "selected" : ""}>admin</option>
							</select>
						</td>
						<td class="py-2 pr-2">
							<div class="flex items-center gap-2">
								<button class="text-xs text-(--primary) hover:underline" data-action="save" data-user-id="${userId}">保存</button>
								<button class="text-xs text-amber-600 dark:text-amber-400 hover:underline" data-action="reset" data-user-id="${userId}">重置密码</button>
								<button class="text-xs text-red-500 hover:underline" data-action="delete" data-user-id="${userId}" data-username="${username}">删除账号</button>
							</div>
						</td>
					</tr>
				`;
      })
      .join("");
  };

  const renderRegistrationRows = (rows: UnknownRecord[]) => {
    if (!registrationTableBody) {
      return;
    }
    if (!Array.isArray(rows) || rows.length === 0) {
      registrationTableBody.innerHTML =
        '<tr><td colspan="7" class="py-4 text-60">暂无申请数据</td></tr>';
      return;
    }
    registrationTableBody.innerHTML = rows
      .map((item) => {
        const avatarFile = String(item.avatar_file || "").trim();
        const avatarHtml = avatarFile
          ? `<img src="/api/v1/public/assets/${encodeURIComponent(avatarFile)}?width=72&height=72&fit=cover" class="w-9 h-9 rounded-full object-cover border border-(--line-divider)" alt="avatar" loading="lazy" />`
          : '<span class="text-xs text-50">无</span>';
        const reason = String(item.registration_reason || "").trim();
        const reviewedBy = String(item.reviewed_by || "").trim();
        const reviewedAt = String(item.reviewed_at || "").trim();
        const detail = [
          `邮箱: ${item.email || ""}`,
          `用户名: ${item.username || ""}`,
          `昵称: ${item.display_name || ""}`,
          `申请状态: ${item.request_status || ""}`,
          `注册理由: ${reason || "无"}`,
          `拒绝原因: ${item.reject_reason || "无"}`,
          `取消原因: ${item.cancel_reason || "无"}`,
          `审批人: ${reviewedBy || "无"}`,
          `审批时间: ${reviewedAt || "无"}`,
        ].join("\n");
        const status = String(item.request_status || "");
        const canReview = status === "pending";
        return `
					<tr class="border-b border-(--line-divider) text-75">
						<td class="py-2 pr-2">${avatarHtml}</td>
						<td class="py-2 pr-2">${item.email || ""}</td>
						<td class="py-2 pr-2">${item.username || ""}</td>
						<td class="py-2 pr-2">${item.display_name || ""}</td>
						<td class="py-2 pr-2">${status || ""}</td>
						<td class="py-2 pr-2">${item.date_created || ""}</td>
						<td class="py-2 pr-2">
							<div class="flex items-center gap-2">
								<button class="text-xs text-60 hover:text-(--primary) hover:underline" data-registration-action="detail" data-registration-id="${item.id}" data-registration-detail="${encodeURIComponent(detail)}">详情</button>
								${
                  canReview
                    ? `<button class="text-xs text-emerald-600 hover:underline" data-registration-action="approve" data-registration-id="${item.id}">通过</button>
								<button class="text-xs text-amber-600 hover:underline" data-registration-action="reject" data-registration-id="${item.id}">拒绝</button>
								<button class="text-xs text-red-500 hover:underline" data-registration-action="cancel" data-registration-id="${item.id}">取消</button>`
                    : ""
                }
							</div>
						</td>
					</tr>
				`;
      })
      .join("");
  };

  const loadUsers = async () => {
    const { response, data } = await api("/api/v1/admin/users?limit=200");
    if (!response.ok || !data?.ok) {
      renderUsersRows([]);
      return;
    }
    renderUsersRows(data.items || []);
  };

  const loadRegisterSwitch = async () => {
    const { response, data } = await api("/api/v1/admin/settings/site");
    if (!response.ok || !data?.ok) {
      setRegisterMessage(resolveErrorMessage(data, "读取开关失败"));
      return;
    }
    const enabled = Boolean(data?.settings?.auth?.register_enabled);
    if (registerEnabledInput) {
      registerEnabledInput.checked = enabled;
    }
    setRegisterMessage("");
  };

  const loadRegistrationRequests = async () => {
    const status =
      String(registrationStatusSelect?.value || "").trim() || "pending";
    const params =
      status && status !== "all"
        ? `?status=${encodeURIComponent(status)}&limit=200`
        : "?limit=200";
    const { response, data } = await api(
      `/api/v1/admin/registration-requests${params}`,
    );
    if (!response.ok || !data?.ok) {
      renderRegistrationRows([]);
      setRegistrationMessage(resolveErrorMessage(data, "加载申请失败"));
      return;
    }
    setRegistrationMessage("");
    renderRegistrationRows(data.items || []);
  };

  document
    .getElementById("admin-users-refresh")
    ?.addEventListener("click", () => void loadUsers());

  document
    .getElementById("admin-registration-refresh")
    ?.addEventListener("click", () => void loadRegistrationRequests());

  registrationStatusSelect?.addEventListener("change", () => {
    void loadRegistrationRequests();
  });

  registerEnabledInput?.addEventListener("change", async () => {
    if (!registerEnabledInput) {
      return;
    }
    const previousChecked = !registerEnabledInput.checked;
    registerEnabledInput.disabled = true;
    setRegisterMessage("保存中...");
    const { response, data } = await api("/api/v1/admin/settings/site", {
      method: "PATCH",
      body: JSON.stringify({
        auth: {
          register_enabled: Boolean(registerEnabledInput.checked),
        },
      }),
    });
    if (!response.ok || !data?.ok) {
      registerEnabledInput.checked = previousChecked;
      registerEnabledInput.disabled = false;
      setRegisterMessage(resolveErrorMessage(data, "保存失败"));
      return;
    }
    registerEnabledInput.disabled = false;
    setRegisterMessage("保存成功");
  });

  usersTableBody?.addEventListener("click", async (event) => {
    const target = event.target instanceof HTMLElement ? event.target : null;
    if (!target) return;
    const action = target.getAttribute("data-action");
    const userId = target.getAttribute("data-user-id");
    if (!action || !userId) return;

    if (action === "save") {
      const row = target.closest("tr");
      if (!row) return;
      const appRole = (
        row.querySelector(
          `select[data-user-id="${userId}"][data-field="app_role"]`,
        ) as HTMLSelectElement | null
      )?.value;
      const { response, data } = await api(`/api/v1/admin/users/${userId}`, {
        method: "PATCH",
        body: JSON.stringify({
          app_role: appRole,
        }),
      });
      if (!response.ok || !data?.ok) {
        window.alert(resolveErrorMessage(data, "保存失败"));
        return;
      }
      await loadUsers();
      return;
    }

    if (action === "reset") {
      const nextPassword = window.prompt("输入新密码");
      if (!nextPassword) return;
      const { response, data } = await api(
        `/api/v1/admin/users/${userId}/reset-password`,
        {
          method: "POST",
          body: JSON.stringify({ new_password: nextPassword }),
        },
      );
      if (!response.ok || !data?.ok) {
        window.alert(resolveErrorMessage(data, "重置失败"));
        return;
      }
      window.alert("密码已重置");
      return;
    }

    if (action === "delete") {
      const username = String(
        target.getAttribute("data-username") || "",
      ).trim();
      const expectedText = `确认删除${username || userId}`;
      const confirmDelete = await showConfirmDialog({
        message: "确认删除这个账号？删除后不可恢复。",
        confirmText: "确认删除",
        confirmVariant: "danger",
        manualConfirm: {
          expectedText,
          placeholder: expectedText,
          mismatchMessage: "输入内容不匹配，请重试",
        },
      });
      if (!confirmDelete) {
        return;
      }

      const { response, data } = await api(`/api/v1/admin/users/${userId}`, {
        method: "DELETE",
      });
      if (!response.ok || !data?.ok) {
        window.alert(resolveErrorMessage(data, "删除失败"));
        return;
      }
      window.alert("账号已删除");
      await loadUsers();
    }
  });

  registrationTableBody?.addEventListener("click", async (event) => {
    const target = event.target instanceof HTMLElement ? event.target : null;
    if (!target) {
      return;
    }
    const action = String(
      target.getAttribute("data-registration-action") || "",
    );
    const requestId = String(target.getAttribute("data-registration-id") || "");
    if (!action) {
      return;
    }

    if (action === "detail") {
      const detail = decodeURIComponent(
        String(target.getAttribute("data-registration-detail") || ""),
      );
      window.alert(detail || "无详情");
      return;
    }

    if (!requestId) {
      return;
    }

    const payload: { action: string; password?: string; reason?: string } = {
      action,
    };
    if (action === "approve") {
      const password = window.prompt("请输入初始密码");
      if (!password) {
        return;
      }
      payload.password = password;
    }
    if (action === "reject" || action === "cancel") {
      const reason = window.prompt("请输入原因（可选）");
      payload.reason = reason || "";
    }

    setRegistrationMessage("处理中...");
    const { response, data } = await api(
      `/api/v1/admin/registration-requests/${encodeURIComponent(requestId)}`,
      {
        method: "PATCH",
        body: JSON.stringify(payload),
      },
    );
    if (!response.ok || !data?.ok) {
      setRegistrationMessage(resolveErrorMessage(data, "操作失败"));
      return;
    }

    setRegistrationMessage("操作成功");
    await loadRegistrationRequests();
    if (action === "approve") {
      await loadUsers();
    }
  });

  void Promise.all([
    loadUsers(),
    loadRegistrationRequests(),
    loadRegisterSwitch(),
  ]);
  document.addEventListener("astro:after-swap", () => {
    void Promise.all([
      loadUsers(),
      loadRegistrationRequests(),
      loadRegisterSwitch(),
    ]);
  });
</script>
