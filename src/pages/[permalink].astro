---
import MainGridLayout from "@layouts/MainGridLayout.astro";

export const prerender = false;

const permalink = String(Astro.params.permalink || "").trim();
let notFound = false;

if (!permalink) {
	notFound = true;
	Astro.response.status = 404;
} else {
	try {
		const endpoint = `${Astro.url.origin}/api/v1/public/articles/${encodeURIComponent(permalink)}/`;
		const response = await fetch(endpoint, {
			headers: {
				Accept: "application/json",
			},
		});
		const data = await response.json().catch(() => null);

		if (response.ok && data?.ok && data.item?.id) {
			return Astro.redirect(`/posts/${data.item.id}/`, 302);
		}

		notFound = true;
		Astro.response.status = 404;
	} catch (error) {
		console.error("[permalink] failed to resolve permalink:", error);
		notFound = true;
		Astro.response.status = 500;
	}
}
---

<MainGridLayout title="页面不存在" description="未找到对应内容">
	<div class="card-base p-8 rounded-[var(--radius-large)]">
		<h1 class="text-2xl font-bold mb-2">内容不存在</h1>
		<p class="text-70">
			{
				notFound
					? "该链接可能已失效，或内容未公开。"
					: "正在跳转..."
			}
		</p>
	</div>
</MainGridLayout>
