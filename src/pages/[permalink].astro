---
import MainGridLayout from "@layouts/MainGridLayout.astro";
import {
	isSpecialArticleSlug,
	loadPublicArticleById,
	loadPublicArticleBySlug,
} from "@/server/api/v1/shared";

export const prerender = false;

const permalink = String(Astro.params.permalink || "").trim();
let notFound = false;

if (!permalink) {
	notFound = true;
	Astro.response.status = 404;
} else {
	try {
		const article =
			(await loadPublicArticleById(permalink)) ||
			(isSpecialArticleSlug(permalink)
				? await loadPublicArticleBySlug(permalink)
				: null);

		if (article?.id) {
			return Astro.redirect(`/posts/${article.id}/`, 302);
		}

		notFound = true;
		Astro.response.status = 404;
	} catch (error) {
		console.error("[permalink] failed to resolve permalink:", error);
		notFound = true;
		Astro.response.status = 500;
	}
}
---

<MainGridLayout title="页面不存在" description="未找到对应内容">
	<div class="card-base p-8 rounded-[var(--radius-large)]">
		<h1 class="text-2xl font-bold mb-2">内容不存在</h1>
		<p class="text-70">
			{
				notFound
					? "该链接可能已失效，或内容未公开。"
					: "正在跳转..."
			}
		</p>
	</div>
</MainGridLayout>
