---
import I18nKey from "@i18n/i18nKey";
import { i18n } from "@i18n/translation";
import MainGridLayout from "@layouts/MainGridLayout.astro";
import PostPage from "@components/PostPage.astro";
import Calendar from "@components/widget/Calendar.astro";
import { getSortedPosts, getTagList, getCategoryList } from "@utils/content-utils";

export const prerender = false;

const allPosts = await getSortedPosts();
const tags = await getTagList();
const categories = await getCategoryList();
const uncategorizedLabel = i18n(I18nKey.uncategorized);
---

<MainGridLayout title={i18n(I18nKey.archive)}>
	<!-- 默认 slot: 文章列表 -->
	<div class="archive-posts min-w-0" data-uncategorized-label={uncategorizedLabel}>
		{allPosts.length === 0 ? (
			<div class="card-base p-8 rounded-[var(--radius-large)] text-70">
				暂无公开文章。
			</div>
		) : (
			<PostPage page={{ data: allPosts }} maxAnimationIndex={15} />
		)}

		<!-- 无筛选结果提示 -->
		<div id="archive-no-results" class="hidden card-base p-8 rounded-[var(--radius-large)] text-70 mt-4">
			没有匹配的文章。
		</div>

		<!-- 分页控件 -->
		<div id="archive-pagination" class="hidden mt-4">
			<div class="card-base p-3 rounded-[var(--radius-large)] flex items-center justify-center gap-2">
				<button id="page-prev" class="pagination-btn" aria-label="上一页">＜</button>
				<div id="page-numbers" class="flex items-center gap-1"></div>
				<button id="page-next" class="pagination-btn" aria-label="下一页">＞</button>
			</div>
		</div>
	</div>

	<!-- 右侧栏 slot: 筛选面板 -->
	<div slot="sidebar-right" class="archive-filter-panel max-h-[calc(100vh-6.5rem)] overflow-y-auto flex flex-col gap-4 self-start">
		<!-- 日历 -->
		<Calendar />

		<!-- 分类 -->
		<div class="card-base rounded-[var(--radius-large)] pb-4">
			<div class="font-bold transition text-lg text-neutral-900 dark:text-neutral-100 relative ml-8 mt-4 mb-2 flex items-center
				before:w-1 before:h-4 before:rounded-md before:bg-[var(--primary)]
				before:absolute before:left-[-16px] before:top-[5.5px]">
				{i18n(I18nKey.categories)}
			</div>
			<div class="px-4 flex flex-col gap-0.5" id="archive-categories">
				{categories.map((c) => (
					<button
						data-filter="category"
						data-value={c.name}
						class="archive-filter-btn w-full h-10 rounded-lg bg-none
							hover:bg-[var(--btn-plain-bg-hover)] active:bg-[var(--btn-plain-bg-active)]
							transition-all pl-2 hover:pl-3 text-left
							text-neutral-700 hover:text-[var(--primary)]
							dark:text-neutral-300 dark:hover:text-[var(--primary)]
							cursor-pointer"
					>
						<div class="flex items-center justify-between mr-2">
							<span class="overflow-hidden whitespace-nowrap text-ellipsis">{c.name.trim()}</span>
							<span class="transition px-2 h-7 ml-4 min-w-[2rem] rounded-lg text-sm font-bold
								text-[var(--btn-content)] dark:text-[var(--deep-text)]
								bg-[oklch(0.95_0.025_var(--hue))] dark:bg-[var(--primary)]
								flex items-center justify-center shrink-0">
								{c.count}
							</span>
						</div>
					</button>
				))}
			</div>
		</div>

		<!-- 标签 -->
		<div class="card-base rounded-[var(--radius-large)] pb-4">
			<div class="font-bold transition text-lg text-neutral-900 dark:text-neutral-100 relative ml-8 mt-4 mb-2 flex items-center
				before:w-1 before:h-4 before:rounded-md before:bg-[var(--primary)]
				before:absolute before:left-[-16px] before:top-[5.5px]">
				{i18n(I18nKey.tags)}
			</div>
			<div class="px-4 flex gap-2 flex-wrap" id="archive-tags">
				{tags.map((t) => (
					<button
						data-filter="tag"
						data-value={t.name}
						class="archive-filter-btn btn-regular h-8 text-sm px-3 rounded-lg cursor-pointer"
					>
						{t.name.trim()}
					</button>
				))}
			</div>
		</div>

		<!-- 筛选状态栏 -->
		<div id="filter-status" class="hidden card-base rounded-[var(--radius-large)] px-4 py-3 flex items-center justify-between gap-2">
			<span id="filter-status-label" class="text-sm text-75 truncate"></span>
			<button id="filter-clear-btn" class="shrink-0 text-sm text-[var(--primary)] hover:underline cursor-pointer">
				清除
			</button>
		</div>
	</div>
</MainGridLayout>

<style>
	/* 自定义滚动条 */
	.archive-filter-panel::-webkit-scrollbar {
		width: 4px;
	}
	.archive-filter-panel::-webkit-scrollbar-track {
		background: transparent;
	}
	.archive-filter-panel::-webkit-scrollbar-thumb {
		background-color: rgba(156, 163, 175, 0.3);
		border-radius: 2px;
	}

	/* 移动端/平板端：筛选面板回归自然高度 */
	@media (max-width: 1279px) {
		.archive-filter-panel {
			max-height: none !important;
			overflow-y: visible !important;
		}
	}

	/* 激活状态的筛选按钮 */
	:global(.archive-filter-btn.active) {
		background-color: var(--primary) !important;
		color: white !important;
	}
	:global(.archive-filter-btn.active .flex span:last-child) {
		background-color: rgba(255, 255, 255, 0.2) !important;
		color: white !important;
	}

	/* 分页样式 */
	:global(.pagination-btn) {
		@apply px-3 py-2 rounded-lg text-sm font-bold
			text-neutral-600 dark:text-neutral-400
			hover:bg-[var(--btn-plain-bg-hover)]
			hover:text-[var(--primary)]
			transition-colors cursor-pointer;
	}
	:global(.pagination-btn.disabled) {
		@apply opacity-40 pointer-events-none;
	}
	:global(.page-num) {
		@apply w-9 h-9 rounded-lg text-sm font-bold
			flex items-center justify-center cursor-pointer
			transition-colors
			text-neutral-700 dark:text-neutral-300
			hover:bg-[var(--btn-plain-bg-hover)];
	}
	:global(.page-num.active) {
		@apply bg-[var(--primary)] text-white dark:text-black/70 cursor-default;
	}
</style>
